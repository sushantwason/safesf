# Monitoring and Alerting Configuration for SF 311 Predictor

# Cloud Monitoring Alerts
alerts:
  - name: high_error_rate
    display_name: "High Error Rate"
    condition:
      threshold:
        comparison: COMPARISON_GT
        threshold_value: 0.05  # 5% error rate
        duration: 300s  # 5 minutes
        aggregations:
          - alignment_period: 60s
            per_series_aligner: ALIGN_RATE
    notification_channels:
      - email
    documentation:
      content: "Error rate has exceeded 5% for 5 minutes"
      mime_type: text/markdown

  - name: high_latency
    display_name: "High API Latency"
    condition:
      threshold:
        comparison: COMPARISON_GT
        threshold_value: 2000  # 2 seconds
        duration: 300s
        aggregations:
          - alignment_period: 60s
            per_series_aligner: ALIGN_MEAN
    notification_channels:
      - email
    documentation:
      content: "API response time exceeded 2 seconds"
      mime_type: text/markdown

  - name: low_availability
    display_name: "Low Service Availability"
    condition:
      threshold:
        comparison: COMPARISON_LT
        threshold_value: 0.99  # 99% uptime
        duration: 600s  # 10 minutes
        aggregations:
          - alignment_period: 60s
            per_series_aligner: ALIGN_MEAN
    notification_channels:
      - email
    documentation:
      content: "Service availability dropped below 99%"
      mime_type: text/markdown

  - name: high_cost
    display_name: "Unexpected High Costs"
    condition:
      threshold:
        comparison: COMPARISON_GT
        threshold_value: 100  # $100/day
        duration: 3600s  # 1 hour
    notification_channels:
      - email
    documentation:
      content: "Daily costs exceeded $100"
      mime_type: text/markdown

# Custom Metrics
custom_metrics:
  - name: prediction_count
    type: GAUGE
    value_type: INT64
    unit: "1"
    labels:
      - category
      - model_type

  - name: prediction_latency
    type: GAUGE
    value_type: DOUBLE
    unit: "ms"
    labels:
      - category
      - model_type

  - name: model_accuracy
    type: GAUGE
    value_type: DOUBLE
    unit: "1"
    labels:
      - category
      - model_type

  - name: data_freshness
    type: GAUGE
    value_type: INT64
    unit: "s"
    description: "Time since last data update"

# Dashboard Configuration
dashboards:
  - name: main_dashboard
    display_name: "SF 311 Predictor - Main Dashboard"
    widgets:
      - title: "Request Rate"
        xy_chart:
          timeseries:
            - metric: "run.googleapis.com/request_count"
              resource_type: "cloud_run_revision"

      - title: "Error Rate"
        xy_chart:
          timeseries:
            - metric: "run.googleapis.com/request_count"
              resource_type: "cloud_run_revision"
              filter: 'response_code_class="5xx"'

      - title: "Latency (P50, P95, P99)"
        xy_chart:
          timeseries:
            - metric: "run.googleapis.com/request_latencies"
              resource_type: "cloud_run_revision"

      - title: "Memory Utilization"
        xy_chart:
          timeseries:
            - metric: "run.googleapis.com/container/memory/utilizations"
              resource_type: "cloud_run_revision"

      - title: "CPU Utilization"
        xy_chart:
          timeseries:
            - metric: "run.googleapis.com/container/cpu/utilizations"
              resource_type: "cloud_run_revision"

      - title: "Active Instances"
        xy_chart:
          timeseries:
            - metric: "run.googleapis.com/container/instance_count"
              resource_type: "cloud_run_revision"

# Log-based Metrics
log_metrics:
  - name: prediction_errors
    filter: 'resource.type="cloud_run_revision" AND severity="ERROR" AND jsonPayload.message=~"Prediction.*failed"'
    metric_descriptor:
      metric_kind: DELTA
      value_type: INT64

  - name: model_load_failures
    filter: 'resource.type="cloud_run_revision" AND severity="ERROR" AND jsonPayload.message=~"Error loading.*model"'
    metric_descriptor:
      metric_kind: DELTA
      value_type: INT64

# SLO Configuration
slos:
  - name: availability_slo
    display_name: "99% Availability SLO"
    service_level_indicator:
      request_based:
        good_total_ratio:
          good_service_filter: 'metric.type="run.googleapis.com/request_count" AND metric.response_code_class="2xx"'
          total_service_filter: 'metric.type="run.googleapis.com/request_count"'
    goal: 0.99
    rolling_period_days: 30

  - name: latency_slo
    display_name: "95% requests under 1s"
    service_level_indicator:
      request_based:
        distribution_cut:
          distribution_filter: 'metric.type="run.googleapis.com/request_latencies"'
          range:
            max: 1000  # 1 second in ms
    goal: 0.95
    rolling_period_days: 30

# Uptime Checks
uptime_checks:
  - display_name: "SF 311 Predictor - Health Check"
    monitored_resource:
      type: "uptime_url"
      labels:
        host: "YOUR_CLOUD_RUN_URL"
    http_check:
      path: "/health"
      port: 443
      use_ssl: true
      accepted_response_status_codes:
        - 200
    timeout: 10s
    period: 60s  # Check every minute

# Budget Alerts
budgets:
  - display_name: "SF 311 Predictor Monthly Budget"
    amount:
      specified_amount:
        units: 100  # $100
    threshold_rules:
      - threshold_percent: 0.5  # Alert at 50%
      - threshold_percent: 0.75  # Alert at 75%
      - threshold_percent: 0.9   # Alert at 90%
      - threshold_percent: 1.0   # Alert at 100%
