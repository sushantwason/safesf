<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SF 311 Request Predictor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 antialiased">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-blue-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold flex items-center">
                            <i class="fas fa-chart-line mr-3"></i>
                            SF 311 Request Predictor
                        </h1>
                        <p class="text-blue-100 mt-1">Predictive analytics for San Francisco 311 service requests</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-blue-100">Powered by SF Open Data</div>
                        <div class="text-xs text-blue-200 mt-1">Updated daily at 6am PT</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Status Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500 text-sm">System Status</p>
                            <p class="text-2xl font-bold text-gray-800" id="systemStatus">Loading...</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i class="fas fa-layer-group text-blue-600 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500 text-sm">Request Types</p>
                            <p class="text-2xl font-bold text-gray-800" id="categoriesCount">-</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-purple-100 rounded-lg">
                            <i class="fas fa-database text-purple-600 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500 text-sm">Total Requests</p>
                            <p class="text-2xl font-bold text-gray-800" id="totalRequestsCount">50,000</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-orange-100 rounded-lg">
                            <i class="fas fa-chart-bar text-orange-600 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500 text-sm">Daily Average</p>
                            <p class="text-2xl font-bold text-gray-800" id="dailyAvgCount">2,273</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historical Data Dashboard -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-history mr-2 text-blue-600"></i>
                    Historical Data (Real 311 Requests)
                </h2>

                <!-- Volume Over Time -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-8 mb-8 hover:shadow-md transition-shadow">
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-chart-line mr-2 text-blue-600"></i>
                            Request Volume Over Time
                        </h3>
                        <p class="text-gray-600 text-sm mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Daily count of 311 requests. Spikes may indicate city events, weather issues, or service problems.
                        </p>
                    </div>
                    <div id="historicalVolumeChart"></div>
                </div>

                <!-- Two column layout for Category and District -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Top Categories -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-8 hover:shadow-md transition-shadow">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">
                            <i class="fas fa-list-ol mr-2 text-green-600"></i>
                            Top Request Categories
                        </h3>
                        <p class="text-gray-600 text-sm mb-4">
                            <i class="fas fa-info-circle mr-1"></i>
                            Most common types of 311 requests submitted by SF residents.
                        </p>
                        <div id="categoriesChart" class="h-96"></div>
                    </div>

                    <!-- Geographic Distribution -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">
                            <i class="fas fa-map-marked-alt mr-2 text-purple-600"></i>
                            Requests by District
                        </h3>
                        <p class="text-gray-600 text-sm mb-4">
                            <i class="fas fa-info-circle mr-1"></i>
                            Service request distribution across SF's 11 supervisor districts.
                        </p>
                        <div id="geographicChart" class="h-96"></div>
                    </div>
                </div>

                <!-- Recent Requests Table -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-stream mr-2 text-orange-600"></i>
                        Recent Service Requests
                    </h3>
                    <p class="text-gray-600 text-sm mb-4">
                        <i class="fas fa-info-circle mr-1"></i>
                        Latest 20 requests submitted to SF's 311 system. Refreshed from live data.
                    </p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">District</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentRequestsTable" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="5" class="px-4 py-3 text-center text-gray-500">Loading recent requests...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Resource Planning & Trends Analysis -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-chart-pie mr-2 text-purple-600"></i>
                    Resource Planning & Trends
                </h2>

                <!-- Day of Week + Weather Impact Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Day of Week Pattern -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-8 hover:shadow-md transition-shadow">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-calendar-week mr-2 text-indigo-600"></i>
                            Day of Week Pattern
                        </h3>
                        <div id="dayOfWeekChart" style="height: 380px;"></div>
                        <div id="dayOfWeekInsight" class="mt-6 p-4 bg-indigo-50 rounded-lg border-l-4 border-indigo-500">
                            <div class="flex items-start">
                                <i class="fas fa-lightbulb text-indigo-600 text-xl mr-3 mt-1"></i>
                                <div>
                                    <p class="font-semibold text-gray-800 mb-1">Key Insight</p>
                                    <p class="text-gray-700 text-sm" id="dayOfWeekInsightText">Loading insights...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Weather Impact -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-8 hover:shadow-md transition-shadow">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-cloud-rain mr-2 text-blue-600"></i>
                            Weather Impact
                        </h3>
                        <div id="weatherImpactChart" style="height: 380px;"></div>
                        <div id="weatherInsight" class="mt-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                            <div class="flex items-start">
                                <i class="fas fa-lightbulb text-blue-600 text-xl mr-3 mt-1"></i>
                                <div>
                                    <p class="font-semibold text-gray-800 mb-1">Key Insight</p>
                                    <p class="text-gray-700 text-sm" id="weatherInsightText">Loading insights...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hourly Pattern (Full Width) -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-8 mb-8 hover:shadow-md transition-shadow">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-clock mr-2 text-orange-600"></i>
                        Peak Hours Analysis
                    </h3>
                    <div id="hourlyPatternChart" style="height: 350px;"></div>
                    <div id="hourlyInsight" class="mt-6 p-4 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                        <div class="flex items-start">
                            <i class="fas fa-lightbulb text-orange-600 text-xl mr-3 mt-1"></i>
                            <div>
                                <p class="font-semibold text-gray-800 mb-1">Key Insight</p>
                                <p class="text-gray-700 text-sm" id="hourlyInsightText">Loading insights...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Trends (Full Width) -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-8 hover:shadow-md transition-shadow">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-line mr-2 text-green-600"></i>
                        Monthly Trends & Seasonality
                    </h3>
                    <div id="monthlyTrendsChart" style="height: 400px;"></div>
                    <div id="monthlyInsight" class="mt-6 p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                        <div class="flex items-start">
                            <i class="fas fa-lightbulb text-green-600 text-xl mr-3 mt-1"></i>
                            <div>
                                <p class="font-semibold text-gray-800 mb-1">Key Insight</p>
                                <p class="text-gray-700 text-sm" id="monthlyInsightText">Loading insights...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Category-Specific Deep Insights -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-microscope mr-2 text-purple-600"></i>
                    Category-Specific Deep Insights
                </h2>
                <p class="text-gray-600 mb-6">
                    Actionable patterns for each request type to optimize resource deployment and staffing.
                </p>

                <!-- Category Growth Trends -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-chart-line mr-2 text-purple-600"></i>
                        Category Growth Trends (Last 8 Months)
                    </h3>
                    <div id="categoryGrowthChart" style="height: 400px;"></div>
                    <div id="categoryGrowthInsight" class="mt-6 p-4 bg-purple-50 rounded-lg border-l-4 border-purple-500">
                        <div class="flex items-start">
                            <i class="fas fa-lightbulb text-purple-600 text-xl mr-3 mt-1"></i>
                            <div>
                                <p class="font-semibold text-gray-800 mb-1">Key Insight</p>
                                <p class="text-gray-700 text-sm" id="categoryGrowthInsightText">Loading insights...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- District Hotspots by Category -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-map-marked-alt mr-2 text-red-600"></i>
                        District Hotspots by Category
                    </h3>
                    <div id="districtHotspotsChart" style="height: 300px;"></div>
                    <div id="districtHotspotsInsight" class="mt-6 p-4 bg-red-50 rounded-lg border-l-4 border-red-500">
                        <div class="flex items-start">
                            <i class="fas fa-lightbulb text-red-600 text-xl mr-3 mt-1"></i>
                            <div>
                                <p class="font-semibold text-gray-800 mb-1">Key Insight</p>
                                <p class="text-gray-700 text-sm" id="districtHotspotsInsightText">Loading insights...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Actionable Recommendations -->
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-6 border border-purple-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-tasks mr-2 text-purple-600"></i>
                        Top Actionable Recommendations
                    </h3>
                    <div id="actionableRecommendations" class="space-y-3">
                        <p class="text-gray-500">Loading recommendations...</p>
                    </div>
                </div>
            </div>

            <!-- Prediction Controls (Coming Soon) -->
            <div class="bg-yellow-50 border-l-4 border-yellow-500 rounded-lg shadow p-6 mb-6">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">
                            ⚠️ Predictions Coming Soon
                        </h3>
                        <p class="text-gray-700 mb-3">
                            Machine learning models are not yet trained. To enable predictions, we need:
                        </p>
                        <ol class="list-decimal list-inside space-y-1 text-gray-700 mb-3">
                            <li>Collect more historical data (need 6+ months)</li>
                            <li>Train Prophet and XGBoost forecasting models</li>
                            <li>Deploy updated models to production</li>
                        </ol>
                        <p class="text-gray-600 text-sm">
                            <strong>For now:</strong> Explore the historical data above to understand request patterns and trends.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Prediction Controls -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-sliders-h mr-2"></i>
                    Prediction Controls
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <select id="categorySelect" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="">Loading categories...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Forecast Days</label>
                        <input type="number" id="forecastDays" value="7" min="1" max="30"
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                        <select id="modelSelect" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="prophet">Prophet (Time Series)</option>
                            <option value="xgboost">XGBoost (ML)</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="getPrediction()"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">
                            <i class="fas fa-magic mr-2"></i>
                            Generate Prediction
                        </button>
                    </div>
                </div>
            </div>

            <!-- Prediction Chart -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-chart-area mr-2"></i>
                    Volume Prediction
                </h2>
                <div id="predictionChart" class="h-96"></div>
            </div>

            <!-- Trends Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-trending-up mr-2"></i>
                        30-Day Trends
                    </h2>
                    <div id="trendsContainer" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">Select a category to view trends</p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-map-marked-alt mr-2"></i>
                        Predicted Hotspots
                    </h2>
                    <div id="hotspotsContainer" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">Loading hotspot predictions...</p>
                    </div>
                </div>
            </div>

            <!-- Model Performance -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-chart-bar mr-2"></i>
                    Model Performance Metrics
                </h2>
                <div id="metricsTable" class="overflow-x-auto">
                    <p class="text-gray-500 text-center py-8">Loading metrics...</p>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white mt-12">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm">Built with SF Open Data for the public good</p>
                        <p class="text-xs text-gray-400 mt-1">Data updated nightly from data.sfgov.org</p>
                    </div>
                    <div class="flex space-x-4">
                        <a href="https://data.sfgov.org/" target="_blank" class="text-gray-400 hover:text-white transition">
                            <i class="fas fa-database"></i> Data Source
                        </a>
                        <a href="/docs" class="text-gray-400 hover:text-white transition">
                            <i class="fas fa-book"></i> API Docs
                        </a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        const API_URL = window.location.origin;  // Adjust for your deployment

        // San Francisco Supervisor District names
        const DISTRICT_NAMES = {
            1: 'Richmond',
            2: 'Marina, Cow Hollow',
            3: 'North Beach, Chinatown',
            4: 'Sunset',
            5: 'Haight-Ashbury, Fillmore',
            6: 'SOMA, Tenderloin',
            7: 'Mission, Bernal Heights',
            8: 'Castro, Noe Valley',
            9: 'Mission, Portola',
            10: 'Potrero Hill, Bayview',
            11: 'Excelsior, Outer Mission'
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await checkHealth();
            await loadCategories();
            await loadMetrics();

            // Load historical data visualizations
            await loadHistoricalTrends();
            await loadCategoryBreakdown();
            await loadRecentRequests();
            await loadGeographicData();

            // Load resource planning & trends analytics
            await loadDayOfWeekAnalytics();
            await loadHourlyPattern();
            await loadWeatherImpact();
            await loadMonthlyTrends();

            // Load category-specific deep insights
            await loadCategoryGrowthTrends();
            await loadDistrictHotspots();

            // Load prediction features (will show as unavailable if models not loaded)
            await loadHotspots();
        });

        async function checkHealth() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                // Health check succeeded, API is working
                console.log('API health check:', data.status);
            } catch (error) {
                console.error('Health check failed:', error);
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/api/categories`);
                const data = await response.json();

                const select = document.getElementById('categorySelect');
                select.innerHTML = data.categories.map(cat =>
                    `<option value="${cat}">${cat}</option>`
                ).join('');
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }

        async function getPrediction() {
            const category = document.getElementById('categorySelect').value;
            const days = document.getElementById('forecastDays').value;
            const model = document.getElementById('modelSelect').value;

            if (!category) {
                alert('Please select a category');
                return;
            }

            try {
                const response = await fetch(
                    `${API_URL}/api/predict/volume?category=${encodeURIComponent(category)}&days=${days}&model=${model}`
                );
                const data = await response.json();

                // Plot predictions
                plotPrediction(data);

                // Load trends for this category
                loadTrends(category);

            } catch (error) {
                console.error('Prediction failed:', error);
                alert('Prediction failed: ' + error.message);
            }
        }

        function plotPrediction(data) {
            const dates = data.predictions.map(p => p.date);
            const volumes = data.predictions.map(p => p.predicted_volume);
            const lowerBounds = data.predictions.map(p => p.lower_bound || p.predicted_volume * 0.8);
            const upperBounds = data.predictions.map(p => p.upper_bound || p.predicted_volume * 1.2);

            const traces = [
                {
                    x: dates,
                    y: volumes,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Predicted Volume',
                    line: { color: '#2563eb', width: 3 },
                    marker: { size: 8 }
                },
                {
                    x: dates,
                    y: upperBounds,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Upper Bound',
                    line: { color: '#93c5fd', width: 1, dash: 'dash' },
                    fill: 'tonexty',
                    fillcolor: 'rgba(37, 99, 235, 0.1)'
                },
                {
                    x: dates,
                    y: lowerBounds,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Lower Bound',
                    line: { color: '#93c5fd', width: 1, dash: 'dash' }
                }
            ];

            const layout = {
                title: `Predicted 311 Requests: ${data.category}`,
                xaxis: { title: 'Date' },
                yaxis: { title: 'Number of Requests' },
                hovermode: 'x unified',
                showlegend: true
            };

            Plotly.newPlot('predictionChart', traces, layout, { responsive: true });
        }

        async function loadTrends(category = 'all') {
            try {
                const response = await fetch(`${API_URL}/api/predict/trends?category=${category}&timeframe=30d`);
                const data = await response.json();

                const container = document.getElementById('trendsContainer');
                container.innerHTML = Object.entries(data.trends).map(([cat, trend]) => `
                    <div class="border-l-4 ${trend.direction === 'increasing' ? 'border-red-500' : 'border-green-500'} pl-4 py-2">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-800">${cat}</span>
                            <span class="text-sm ${trend.direction === 'increasing' ? 'text-red-600' : 'text-green-600'}">
                                <i class="fas fa-arrow-${trend.direction === 'increasing' ? 'up' : 'down'}"></i>
                                ${trend.magnitude_percent}%
                            </span>
                        </div>
                        <div class="text-sm text-gray-600 mt-1">
                            Predicted total: ${trend.predicted_total} | Daily avg: ${trend.daily_average}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load trends:', error);
            }
        }

        async function loadHotspots() {
            try {
                const response = await fetch(`${API_URL}/api/predict/hotspots?top_n=5`);
                const data = await response.json();

                const container = document.getElementById('hotspotsContainer');
                container.innerHTML = data.hotspots.map((spot, idx) => `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-semibold">
                                    #${idx + 1}
                                </span>
                                <h3 class="font-semibold text-gray-800 mt-2">${spot.neighborhood}</h3>
                                <p class="text-sm text-gray-600">Predicted volume: ${spot.predicted_volume}</p>
                            </div>
                        </div>
                        <div class="mt-2 flex flex-wrap gap-1">
                            ${spot.top_categories.map(cat =>
                                `<span class="text-xs bg-gray-200 px-2 py-1 rounded">${cat}</span>`
                            ).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load hotspots:', error);
            }
        }

        // NEW: Historical Data Functions
        async function loadHistoricalTrends() {
            try {
                // Get daily time series data
                const response = await fetch(`${API_URL}/api/data/daily-timeseries`);
                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }
                const data = await response.json();

                if (!data.dates || !data.counts || data.dates.length === 0) {
                    throw new Error('No time series data available');
                }

                const trace = {
                    x: data.dates,
                    y: data.counts,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Daily Requests',
                    line: { color: '#3b82f6', width: 3, shape: 'spline', smoothing: 1.3 },
                    marker: { size: 7, color: '#3b82f6', line: { color: '#1e40af', width: 1 } },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(59, 130, 246, 0.1)'
                };

                const layout = {
                    xaxis: {
                        title: {
                            text: 'Date',
                            font: { size: 13, color: '#4B5563' }
                        },
                        gridcolor: '#F3F4F6',
                        tickfont: { size: 11 }
                    },
                    yaxis: {
                        title: {
                            text: 'Number of Requests',
                            font: { size: 13, color: '#4B5563' }
                        },
                        gridcolor: '#F3F4F6'
                    },
                    hovermode: 'x unified',
                    showlegend: false,
                    margin: { t: 20, r: 20, b: 60, l: 65 },
                    height: 400,
                    paper_bgcolor: '#FFFFFF',
                    plot_bgcolor: '#FAFAFA',
                    font: { family: 'Inter, system-ui, sans-serif' }
                };

                Plotly.newPlot('historicalVolumeChart', [trace], layout, { responsive: true, displayModeBar: false });
            } catch (error) {
                console.error('Failed to load historical trends:', error);
                document.getElementById('historicalVolumeChart').innerHTML =
                    '<p class="text-red-600 p-4">Error loading trend data: ' + error.message + '</p>';
            }
        }

        async function loadCategoryBreakdown() {
            try {
                const response = await fetch(`${API_URL}/api/data/stats`);
                const data = await response.json();

                // Get top 10 categories
                const categories = Object.entries(data.top_categories || data.categories || {})
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

                const trace = {
                    x: categories.map(c => c[1]),
                    y: categories.map(c => c[0]),
                    type: 'bar',
                    orientation: 'h',
                    marker: { color: '#3b82f6' }
                };

                const layout = {
                    xaxis: {
                        title: {
                            text: 'Number of Requests',
                            font: { size: 13, color: '#4B5563' }
                        },
                        gridcolor: '#F3F4F6'
                    },
                    yaxis: {
                        title: '',
                        tickfont: { size: 12 },
                        automargin: true
                    },
                    margin: { t: 20, r: 20, b: 60, l: 200 },
                    height: 500,
                    paper_bgcolor: '#FFFFFF',
                    plot_bgcolor: '#FAFAFA',
                    font: { family: 'Inter, system-ui, sans-serif' }
                };

                Plotly.newPlot('categoriesChart', [trace], layout, { responsive: true, displayModeBar: false });
            } catch (error) {
                console.error('Failed to load category breakdown:', error);
                document.getElementById('categoriesChart').innerHTML =
                    '<p class="text-red-600 p-4">Error loading category data</p>';
            }
        }

        async function loadRecentRequests() {
            try {
                const response = await fetch(`${API_URL}/api/data/recent?limit=20`);
                const data = await response.json();

                const tbody = document.getElementById('recentRequestsTable');
                tbody.innerHTML = data.data.map(req => {
                    let districtDisplay = 'N/A';
                    if (req.district !== null && req.district !== undefined) {
                        const districtNum = Math.floor(req.district);
                        const neighborhoodName = DISTRICT_NAMES[districtNum];
                        districtDisplay = neighborhoodName ? `D${districtNum}: ${neighborhoodName}` : `D${districtNum}`;
                    }
                    return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-2 text-sm">${req.opened ? new Date(req.opened).toLocaleDateString() : 'N/A'}</td>
                        <td class="px-4 py-2 text-sm">${req.category}</td>
                        <td class="px-4 py-2 text-sm">${req.address || 'N/A'}</td>
                        <td class="px-4 py-2 text-sm text-center">${districtDisplay}</td>
                        <td class="px-4 py-2 text-sm">
                            <span class="inline-block px-2 py-1 rounded text-xs ${
                                req.status === 'Closed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                            }">
                                ${req.status}
                            </span>
                        </td>
                    </tr>
                `}).join('');
            } catch (error) {
                console.error('Failed to load recent requests:', error);
                document.getElementById('recentRequestsTable').innerHTML =
                    '<tr><td colspan="5" class="text-center text-red-600 p-4">Error loading recent requests</td></tr>';
            }
        }

        async function loadGeographicData() {
            try {
                const response = await fetch(`${API_URL}/api/data/recent?limit=1000`);
                const data = await response.json();

                // Group by district
                const districtGroups = {};
                data.data.forEach(req => {
                    if (req.district !== null && req.district !== 'N/A' && req.district !== undefined) {
                        const district = Math.floor(req.district).toString();
                        districtGroups[district] = (districtGroups[district] || 0) + 1;
                    }
                });

                const districts = Object.entries(districtGroups)
                    .sort((a, b) => parseInt(b[1]) - parseInt(a[1])); // Sort by count descending

                const trace = {
                    y: districts.map(d => {
                        const districtNum = d[0];
                        const name = DISTRICT_NAMES[districtNum] || `District ${districtNum}`;
                        return `D${districtNum}: ${name}`;
                    }),
                    x: districts.map(d => d[1]),
                    type: 'bar',
                    orientation: 'h',
                    marker: {
                        color: '#8b5cf6',
                        line: { color: '#7c3aed', width: 1 }
                    },
                    text: districts.map(d => d[1]),
                    textposition: 'outside',
                    textfont: { size: 11, color: '#4B5563' }
                };

                const layout = {
                    xaxis: {
                        title: {
                            text: 'Number of Requests',
                            font: { size: 13, color: '#4B5563' }
                        },
                        gridcolor: '#F3F4F6'
                    },
                    yaxis: {
                        title: '',
                        tickfont: { size: 12 },
                        automargin: true
                    },
                    margin: { t: 20, r: 60, b: 60, l: 200 },
                    height: 500,
                    paper_bgcolor: '#FFFFFF',
                    plot_bgcolor: '#FAFAFA',
                    font: { family: 'Inter, system-ui, sans-serif' }
                };

                Plotly.newPlot('geographicChart', [trace], layout, { responsive: true, displayModeBar: false });
            } catch (error) {
                console.error('Failed to load geographic data:', error);
                document.getElementById('geographicChart').innerHTML =
                    '<p class="text-red-600 p-4">Error loading geographic data</p>';
            }
        }

        async function loadMetrics() {
            try {
                const response = await fetch(`${API_URL}/api/data/stats`);
                const data = await response.json();

                // Update status cards with real data
                const numCategories = Object.keys(data.categories || {}).length;
                document.getElementById('categoriesCount').textContent = numCategories.toLocaleString();
                document.getElementById('totalRequestsCount').textContent = (data.total_requests || 0).toLocaleString();
                document.getElementById('dailyAvgCount').textContent = Math.round(data.daily_average || 0).toLocaleString();
            } catch (error) {
                console.error('Failed to load metrics:', error);
            }
        }

        // Resource Planning & Trends Functions
        async function loadDayOfWeekAnalytics() {
            try {
                const response = await fetch(`${API_URL}/api/analytics/day-of-week`);
                const data = await response.json();

                const trace = {
                    x: data.days,
                    y: data.counts,
                    type: 'bar',
                    marker: {
                        color: '#6366f1',
                        line: { color: '#4f46e5', width: 1 }
                    },
                    text: data.counts.map(c => c.toLocaleString()),
                    textposition: 'outside',
                    textfont: { size: 11 }
                };

                const layout = {
                    xaxis: { title: { text: 'Day of Week', font: { size: 13 } } },
                    yaxis: { title: { text: 'Total Requests', font: { size: 13 } }, gridcolor: '#F3F4F6' },
                    margin: { t: 20, r: 20, b: 60, l: 65 },
                    paper_bgcolor: '#FFFFFF',
                    plot_bgcolor: '#FAFAFA',
                    font: { family: 'Inter, system-ui, sans-serif' }
                };

                Plotly.newPlot('dayOfWeekChart', [trace], layout, { responsive: true, displayModeBar: false });

                // Generate insight
                const maxDay = data.days[data.counts.indexOf(Math.max(...data.counts))];
                const minDay = data.days[data.counts.indexOf(Math.min(...data.counts))];
                const maxCount = Math.max(...data.counts);
                const minCount = Math.min(...data.counts);
                const diff = ((maxCount - minCount) / minCount * 100).toFixed(0);

                document.getElementById('dayOfWeekInsightText').innerHTML =
                    `<strong>${maxDay}</strong> has ${diff}% more requests than <strong>${minDay}</strong>. ` +
                    `Staff ${diff}% more resources on Mon-Tue vs weekends for optimal coverage.`;
            } catch (error) {
                console.error('Failed to load day-of-week analytics:', error);
            }
        }

        async function loadHourlyPattern() {
            try {
                const response = await fetch(`${API_URL}/api/analytics/hourly-pattern`);
                const data = await response.json();

                const trace = {
                    x: data.hours.map(h => `${h}:00`),
                    y: data.counts,
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: '#f97316', width: 3, shape: 'spline' },
                    marker: { size: 7, color: '#f97316' },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(249, 115, 22, 0.1)'
                };

                const layout = {
                    xaxis: { title: { text: 'Hour of Day', font: { size: 13 } } },
                    yaxis: { title: { text: 'Average Requests', font: { size: 13 } }, gridcolor: '#F3F4F6' },
                    margin: { t: 20, r: 20, b: 60, l: 65 },
                    paper_bgcolor: '#FFFFFF',
                    plot_bgcolor: '#FAFAFA',
                    annotations: [{
                        x: `${data.peak_hour}:00`,
                        y: data.peak_count,
                        text: `Peak: ${data.peak_hour}:00`,
                        showarrow: true,
                        arrowhead: 2,
                        ax: 0,
                        ay: -40
                    }],
                    font: { family: 'Inter, system-ui, sans-serif' }
                };

                Plotly.newPlot('hourlyPatternChart', [trace], layout, { responsive: true, displayModeBar: false });

                // Generate insight
                const totalRequests = data.counts.reduce((a, b) => a + b, 0);
                const morning8to11 = data.counts.slice(8, 12).reduce((a, b) => a + b, 0);
                const morningPct = (morning8to11 / totalRequests * 100).toFixed(0);

                document.getElementById('hourlyInsightText').innerHTML =
                    `<strong>${data.peak_hour}:00 is peak hour</strong> with ${data.peak_count.toLocaleString()} requests. ` +
                    `Morning rush (8-11 AM) = <strong>${morningPct}% of daily volume</strong>. Schedule heavy staffing during these hours.`;
            } catch (error) {
                console.error('Failed to load hourly pattern:', error);
            }
        }

        async function loadWeatherImpact() {
            try {
                const response = await fetch(`${API_URL}/api/analytics/weather-impact`);
                const data = await response.json();

                const categories = data.category_impacts.slice(0, 8).map(c => c.category);
                const impacts = data.category_impacts.slice(0, 8).map(c => c.impact_percent);
                const colors = impacts.map(i => i > 0 ? '#10b981' : '#ef4444');

                const trace = {
                    y: categories,
                    x: impacts,
                    type: 'bar',
                    orientation: 'h',
                    marker: { color: colors },
                    text: impacts.map(i => `${i > 0 ? '+' : ''}${i}%`),
                    textposition: 'outside',
                    textfont: { size: 11 }
                };

                const layout = {
                    xaxis: { title: { text: '% Change on Rainy Days', font: { size: 13 } }, gridcolor: '#F3F4F6', zeroline: true },
                    yaxis: { title: '', tickfont: { size: 11 }, automargin: true },
                    margin: { t: 40, r: 80, b: 60, l: 200 },
                    paper_bgcolor: '#FFFFFF',
                    plot_bgcolor: '#FAFAFA',
                    annotations: [{
                        text: `Overall: ${data.overall_impact_percent}% on rainy days`,
                        xref: 'paper',
                        yref: 'paper',
                        x: 0.5,
                        y: 1.1,
                        showarrow: false,
                        font: { size: 12, color: '#4B5563' }
                    }],
                    font: { family: 'Inter, system-ui, sans-serif' }
                };

                Plotly.newPlot('weatherImpactChart', [trace], layout, { responsive: true, displayModeBar: false });

                // Generate insight
                const biggestIncrease = data.category_impacts.filter(c => c.impact_percent > 0).sort((a, b) => b.impact_percent - a.impact_percent)[0];
                const biggestDecrease = data.category_impacts.filter(c => c.impact_percent < 0).sort((a, b) => a.impact_percent - b.impact_percent)[0];

                let insightText = `Overall, rainy days see <strong>${Math.abs(data.overall_impact_percent)}% ${data.overall_impact_percent < 0 ? 'fewer' : 'more'} requests</strong>. `;
                if (biggestIncrease) {
                    insightText += `<strong>${biggestIncrease.category}</strong> spikes ${biggestIncrease.impact_percent}% on rainy days. `;
                }
                if (biggestDecrease) {
                    insightText += `Pre-position crews for rain-driven issues.`;
                }

                document.getElementById('weatherInsightText').innerHTML = insightText;
            } catch (error) {
                console.error('Failed to load weather impact:', error);
                document.getElementById('weatherImpactChart').innerHTML =
                    '<p class="text-gray-500 p-4">Weather data not available</p>';
            }
        }

        async function loadMonthlyTrends() {
            try {
                const response = await fetch(`${API_URL}/api/analytics/monthly-trends`);
                const data = await response.json();

                const trace = {
                    x: data.months,
                    y: data.counts,
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: '#22c55e', width: 3, shape: 'spline' },
                    marker: { size: 9, color: '#22c55e', line: { color: '#16a34a', width: 2 } },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(34, 197, 94, 0.1)'
                };

                const avgLine = {
                    x: data.months,
                    y: new Array(data.months.length).fill(data.average),
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#9ca3af', width: 2, dash: 'dash' },
                    name: 'Average'
                };

                const layout = {
                    xaxis: { title: { text: 'Month', font: { size: 13 } } },
                    yaxis: { title: { text: 'Total Requests', font: { size: 13 } }, gridcolor: '#F3F4F6' },
                    margin: { t: 20, r: 20, b: 60, l: 65 },
                    paper_bgcolor: '#FFFFFF',
                    plot_bgcolor: '#FAFAFA',
                    showlegend: false,
                    font: { family: 'Inter, system-ui, sans-serif' }
                };

                Plotly.newPlot('monthlyTrendsChart', [trace, avgLine], layout, { responsive: true, displayModeBar: false });

                // Generate insight
                const maxMonth = data.months[data.counts.indexOf(Math.max(...data.counts))];
                const maxCount = Math.max(...data.counts);
                const avgCount = data.average;
                const spike = ((maxCount - avgCount) / avgCount * 100).toFixed(0);

                document.getElementById('monthlyInsightText').innerHTML =
                    `<strong>${maxMonth}</strong> showed a ${spike}% spike above average (${maxCount.toLocaleString()} vs ${avgCount.toLocaleString()}). ` +
                    `Plan for ${spike}% extra capacity during winter months based on this seasonal pattern.`;
            } catch (error) {
                console.error('Failed to load monthly trends:', error);
            }
        }

        async function loadCategoryGrowthTrends() {
            try {
                const response = await fetch(`${API_URL}/api/analytics/category-insights`);
                const data = await response.json();

                const categories = data.category_growth_trends.map(c => c.category);
                const growths = data.category_growth_trends.map(c => c.growth_pct);
                const colors = growths.map(g => g < 0 ? '#22c55e' : '#ef4444');

                const trace = {
                    y: categories,
                    x: growths,
                    type: 'bar',
                    orientation: 'h',
                    marker: { color: colors },
                    text: growths.map(g => `${g > 0 ? '+' : ''}${g}%`),
                    textposition: 'outside',
                    textfont: { size: 11 }
                };

                const layout = {
                    xaxis: {
                        title: { text: 'Growth % (Last 8 Months)', font: { size: 13 } },
                        gridcolor: '#F3F4F6',
                        zeroline: true,
                        zerolinecolor: '#9ca3af',
                        zerolinewidth: 2
                    },
                    yaxis: { title: '', tickfont: { size: 11 }, automargin: true },
                    margin: { t: 40, r: 80, b: 60, l: 220 },
                    paper_bgcolor: '#FFFFFF',
                    plot_bgcolor: '#FAFAFA',
                    font: { family: 'Inter, system-ui, sans-serif' }
                };

                Plotly.newPlot('categoryGrowthChart', [trace], layout, { responsive: true, displayModeBar: false });

                // Generate insight
                const declining = data.category_growth_trends.filter(c => c.trend === 'DECLINING');
                const mostDeclined = declining[0];

                let insightText = `<strong>${declining.length} categories are declining</strong>, led by <strong>${mostDeclined.category}</strong> (${mostDeclined.growth_pct}%). `;
                insightText += `Plan to <strong>reallocate ${Math.abs(mostDeclined.growth_pct)}% of crews</strong> from ${mostDeclined.category} to growing categories.`;

                document.getElementById('categoryGrowthInsightText').innerHTML = insightText;

                // Load actionable recommendations
                loadActionableRecommendations(data);

            } catch (error) {
                console.error('Failed to load category growth trends:', error);
                document.getElementById('categoryGrowthChart').innerHTML =
                    '<p class="text-gray-500 p-4">Category insights not available</p>';
            }
        }

        async function loadDistrictHotspots() {
            try {
                const response = await fetch(`${API_URL}/api/analytics/category-insights`);
                const data = await response.json();

                const traces = data.district_hotspots.map((hotspot, idx) => ({
                    y: [hotspot.category],
                    x: [hotspot.concentration],
                    type: 'bar',
                    orientation: 'h',
                    name: `District ${hotspot.district} (${DISTRICT_NAMES[hotspot.district]})`,
                    marker: { color: ['#ef4444', '#f59e0b'][idx] },
                    text: [`${hotspot.concentration}%`],
                    textposition: 'outside',
                    textfont: { size: 11 }
                }));

                const layout = {
                    xaxis: {
                        title: { text: '% of Category in District', font: { size: 13 } },
                        gridcolor: '#F3F4F6',
                        range: [0, 40]
                    },
                    yaxis: { title: '', tickfont: { size: 11 }, automargin: true },
                    margin: { t: 40, r: 80, b: 60, l: 200 },
                    paper_bgcolor: '#FFFFFF',
                    plot_bgcolor: '#FAFAFA',
                    barmode: 'group',
                    showlegend: true,
                    legend: { orientation: 'h', y: 1.15, x: 0.5, xanchor: 'center' },
                    font: { family: 'Inter, system-ui, sans-serif' }
                };

                Plotly.newPlot('districtHotspotsChart', traces, layout, { responsive: true, displayModeBar: false });

                // Generate insight
                const hotspot1 = data.district_hotspots[0];
                const hotspot2 = data.district_hotspots[1];

                let insightText = `<strong>${hotspot1.concentration}% of ${hotspot1.category}</strong> occur in District ${hotspot1.district} (${DISTRICT_NAMES[hotspot1.district]}). `;
                insightText += `<strong>${hotspot2.concentration}% of ${hotspot2.category}</strong> occur in District ${hotspot2.district} (${DISTRICT_NAMES[hotspot2.district]}). `;
                insightText += `Station specialized crews in these districts for faster response times.`;

                document.getElementById('districtHotspotsInsightText').innerHTML = insightText;

            } catch (error) {
                console.error('Failed to load district hotspots:', error);
                document.getElementById('districtHotspotsChart').innerHTML =
                    '<p class="text-gray-500 p-4">District hotspot data not available</p>';
            }
        }

        function loadActionableRecommendations(data) {
            const recommendations = [
                {
                    icon: 'clock',
                    color: 'blue',
                    text: 'Parking Enforcement peaks at 9:00 → Deploy officers 1 hour before rush hour'
                },
                {
                    icon: 'map-marker-alt',
                    color: 'red',
                    text: `Graffiti concentrated in District 9 (${DISTRICT_NAMES[9]}) → Station cleanup crews in D9`
                },
                {
                    icon: 'calendar-week',
                    color: 'green',
                    text: 'Street Cleaning 3.0x higher on weekdays → Reduce weekend crews 67%'
                },
                {
                    icon: 'cloud-rain',
                    color: 'indigo',
                    text: 'Sewer issues 2.4x higher on rainy days → Pre-position crews when rain forecasted'
                },
                {
                    icon: 'volume-up',
                    color: 'yellow',
                    text: 'Noise complaints 40% after 6pm, peak at 23:00 → Staff hotline until midnight'
                }
            ];

            const html = recommendations.map(rec => `
                <div class="flex items-start space-x-3 p-3 bg-white rounded border border-gray-200">
                    <i class="fas fa-${rec.icon} text-${rec.color}-600 text-lg mt-1"></i>
                    <p class="text-gray-700 text-sm flex-1">${rec.text}</p>
                </div>
            `).join('');

            document.getElementById('actionableRecommendations').innerHTML = html;
        }
    </script>
</body>
</html>
