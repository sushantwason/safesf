<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SF 311 Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .tab-btn.active { color: #2563eb; border-bottom: 2px solid #2563eb; }
        .tab-btn { border-bottom: 2px solid transparent; }
        #mapContainer { height: calc(100vh - 160px); min-height: 500px; }
        .leaflet-container { background: #f8fafc; }
        .legend-panel { background: white; padding: 10px 14px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); max-height: 300px; overflow-y: auto; }
        .legend-panel h4 { margin: 0 0 8px 0; font-size: 12px; font-weight: 600; color: #374151; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: #4b5563; padding: 2px 0; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    </style>
</head>
<body class="bg-gray-50 antialiased">
    <!-- Fixed Top Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-white border-b border-gray-200 h-14">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <div class="font-bold text-lg text-gray-900 tracking-tight">SF 311</div>
            <div class="flex items-center gap-1">
                <button class="tab-btn active px-3 py-1 text-sm font-medium text-gray-500 hover:text-gray-900 transition" data-tab="overview">Overview</button>
                <button class="tab-btn px-3 py-1 text-sm font-medium text-gray-500 hover:text-gray-900 transition" data-tab="trends">Trends</button>
                <button class="tab-btn px-3 py-1 text-sm font-medium text-gray-500 hover:text-gray-900 transition" data-tab="map">Map</button>
                <button class="tab-btn px-3 py-1 text-sm font-medium text-gray-500 hover:text-gray-900 transition" data-tab="insights">Insights</button>
            </div>
            <div class="flex items-center gap-2">
                <input type="date" id="startDate" class="text-xs border border-gray-300 rounded px-2 py-1">
                <span class="text-gray-400 text-xs">to</span>
                <input type="date" id="endDate" class="text-xs border border-gray-300 rounded px-2 py-1">
                <button id="applyDateRange" class="text-xs bg-blue-600 text-white px-3 py-1 rounded font-medium hover:bg-blue-700 transition">Apply</button>
            </div>
        </div>
    </nav>

    <!-- Category + District Filter Bar (drill-down) -->
    <div class="fixed top-14 left-0 right-0 z-40 bg-gray-50 border-b border-gray-200 h-10">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center gap-4">
            <label class="text-xs text-gray-500 font-medium">Category:</label>
            <select id="globalCategoryFilter" class="text-xs border border-gray-300 rounded px-2 py-1 bg-white">
                <option value="">All Categories</option>
            </select>
            <label class="text-xs text-gray-500 font-medium ml-2">District:</label>
            <select id="globalDistrictFilter" class="text-xs border border-gray-300 rounded px-2 py-1 bg-white">
                <option value="">All Districts</option>
                <option value="1">D1 Richmond</option>
                <option value="2">D2 Marina, Cow Hollow</option>
                <option value="3">D3 North Beach, Chinatown</option>
                <option value="4">D4 Sunset</option>
                <option value="5">D5 Haight, Fillmore</option>
                <option value="6">D6 SOMA, Tenderloin</option>
                <option value="7">D7 Mission, Bernal</option>
                <option value="8">D8 Castro, Noe Valley</option>
                <option value="9">D9 Mission, Portola</option>
                <option value="10">D10 Potrero, Bayview</option>
                <option value="11">D11 Excelsior, Outer Mission</option>
            </select>
            <button id="clearDrillDown" class="text-xs text-blue-600 hover:text-blue-800 font-medium hidden">Clear filters</button>
        </div>
    </div>

    <!-- Main Content (offset for fixed nav + filter bar) -->
    <main class="pt-24 max-w-7xl mx-auto px-4 pb-16">

        <!-- Tab: Overview -->
        <div data-tab-content="overview">
            <!-- KPI Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Open Requests</p>
                    <p class="text-2xl font-bold text-gray-900 mt-1" id="kpiOpen">--</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Avg Resolution</p>
                    <p class="text-2xl font-bold text-gray-900 mt-1" id="kpiResolution">-- hrs</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Anomalies This Week</p>
                    <p class="text-2xl font-bold mt-1" id="kpiAnomalies">--</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Busiest District</p>
                    <p class="text-2xl font-bold text-gray-900 mt-1" id="kpiBusiest">--</p>
                    <p class="text-xs text-gray-400 mt-0.5" id="kpiBusiestCount"></p>
                </div>
            </div>

            <!-- Anomaly Alerts (conditional) -->
            <div id="anomalyAlerts" class="hidden mb-6">
                <div class="bg-red-50 border border-red-200 rounded-xl p-4">
                    <p class="text-sm font-semibold text-red-800 mb-1">Anomalies Detected</p>
                    <div id="anomalyList" class="text-sm text-red-700"></div>
                </div>
            </div>

            <!-- Volume Over Time -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <h3 class="text-sm font-semibold text-gray-900 mb-4">Request Volume Over Time</h3>
                <div id="volumeChart" style="height:320px;"></div>
            </div>

            <!-- Two Column: Categories + Districts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-sm font-semibold text-gray-900 mb-4">Top Request Categories</h3>
                    <div id="categoriesChart" style="height:380px;"></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-sm font-semibold text-gray-900 mb-4">Requests by District</h3>
                    <div id="districtChart" style="height:380px;"></div>
                </div>
            </div>

            <!-- Recent Activity Table -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-sm font-semibold text-gray-900 mb-4">Recent Activity</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-100">
                                <th class="text-left py-2 px-3 text-xs font-medium text-gray-500 uppercase">Date</th>
                                <th class="text-left py-2 px-3 text-xs font-medium text-gray-500 uppercase">Category</th>
                                <th class="text-left py-2 px-3 text-xs font-medium text-gray-500 uppercase">Address</th>
                                <th class="text-left py-2 px-3 text-xs font-medium text-gray-500 uppercase">District</th>
                                <th class="text-left py-2 px-3 text-xs font-medium text-gray-500 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentTable" class="divide-y divide-gray-50">
                            <tr><td colspan="5" class="py-8 text-center text-gray-400">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Trends -->
        <div data-tab-content="trends" class="hidden">
            <!-- Day of Week + Hourly -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-sm font-semibold text-gray-900 mb-4">Day of Week Pattern</h3>
                    <div id="dowChart" style="height:300px;"></div>
                    <p class="text-xs text-gray-500 mt-3" id="dowInsight"></p>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-sm font-semibold text-gray-900 mb-4">Hourly Pattern</h3>
                    <div id="hourlyChart" style="height:300px;"></div>
                    <p class="text-xs text-gray-500 mt-3" id="hourlyInsight"></p>
                </div>
            </div>

            <!-- Monthly Trends -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <h3 class="text-sm font-semibold text-gray-900 mb-4">Monthly Trends &amp; Seasonality</h3>
                <div id="monthlyChart" style="height:320px;"></div>
                <p class="text-xs text-gray-500 mt-3" id="monthlyInsight"></p>
            </div>

            <!-- Category Growth -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <h3 class="text-sm font-semibold text-gray-900 mb-4">Category Growth Trends</h3>
                <div id="growthChart" style="height:360px;"></div>
                <p class="text-xs text-gray-500 mt-3" id="growthInsight"></p>
            </div>

            <!-- Resolution Time Analysis -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-sm font-semibold text-gray-900 mb-4">Resolution Time Analysis</h3>
                <div id="resolutionChart" style="height:360px;"></div>
            </div>
        </div>

        <!-- Tab: Map -->
        <div data-tab-content="map" class="hidden">
            <div class="mb-3" id="mapCategoryToggles"></div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div id="mapContainer"></div>
            </div>
        </div>

        <!-- Tab: Insights -->
        <div data-tab-content="insights" class="hidden">
            <!-- Event Correlation (DataSF) -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <h3 class="text-sm font-semibold text-gray-900 mb-4">311 Volume vs City Events (DataSF)</h3>
                <p class="text-xs text-gray-500 mb-3">Correlates request volume with Our415 events and street closures</p>
                <div id="eventCorrelation" class="text-sm text-gray-600">
                    <p class="text-gray-400">Loading...</p>
                </div>
            </div>

            <!-- District Hotspots -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <h3 class="text-sm font-semibold text-gray-900 mb-4">District Hotspots by Category</h3>
                <div id="hotspotsChart" style="height:300px;"></div>
            </div>

            <!-- Actionable Recommendations -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <h3 class="text-sm font-semibold text-gray-900 mb-4">Top Actionable Recommendations</h3>
                <div id="recommendations" class="space-y-3">
                    <p class="text-gray-400 text-sm py-4 text-center">Loading...</p>
                </div>
            </div>

            <!-- Comparative Period Summary -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <h3 class="text-sm font-semibold text-gray-900 mb-4">Comparative Period Summary</h3>
                <div id="comparativeSummary" class="text-sm text-gray-600">
                    <p class="text-gray-400 text-center py-4">Loading...</p>
                </div>
            </div>

            <!-- Compare Periods (this month vs same month last year) -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-sm font-semibold text-gray-900 mb-4">Compare Periods</h3>
                <p class="text-xs text-gray-500 mb-3">Compare this month to the same month last year</p>
                <div id="comparePeriodsResult" class="text-sm text-gray-600">
                    <p class="text-gray-400">Loading...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-gray-200 bg-white">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
            <p class="text-xs text-gray-400">SF 311 Data &middot; Updated daily &middot; data.sfgov.org</p>
            <div class="flex items-center gap-4">
                <button id="exportCsv" class="text-xs text-blue-600 hover:text-blue-800 font-medium">Export CSV</button>
                <a href="/docs" class="text-xs text-gray-400 hover:text-gray-600">API Docs</a>
            </div>
        </div>
    </footer>

    <script>
    const API_URL = window.location.origin;

    const DISTRICT_NAMES = {
        1: 'Richmond', 2: 'Marina, Cow Hollow', 3: 'North Beach, Chinatown',
        4: 'Sunset', 5: 'Haight-Ashbury, Fillmore', 6: 'SOMA, Tenderloin',
        7: 'Mission, Bernal Heights', 8: 'Castro, Noe Valley', 9: 'Mission, Portola',
        10: 'Potrero Hill, Bayview', 11: 'Excelsior, Outer Mission'
    };

    const CHART_CONFIG = { responsive: true, displayModeBar: false };
    const CHART_LAYOUT_BASE = {
        paper_bgcolor: '#FFFFFF',
        plot_bgcolor: '#FFFFFF',
        font: { family: 'Inter, system-ui, sans-serif', size: 12, color: '#374151' },
        margin: { t: 10, r: 20, b: 50, l: 60 },
        xaxis: { gridcolor: '#f3f4f6', linecolor: '#e5e7eb' },
        yaxis: { gridcolor: '#f3f4f6', linecolor: '#e5e7eb' },
    };

    const MAP_CATEGORY_COLORS = [
        '#2563eb', '#dc2626', '#16a34a', '#d97706', '#7c3aed',
        '#0891b2', '#be185d', '#4f46e5', '#ca8a04', '#059669',
        '#9333ea', '#e11d48', '#0284c7', '#65a30d', '#c026d3',
        '#ea580c', '#1d4ed8', '#15803d', '#b91c1c', '#7e22ce'
    ];

    // State
    let categoriesList = [];
    let tabDataLoaded = { overview: false, trends: false, map: false, insights: false };
    let leafletMap = null;
    let mapLayerGroups = {};
    let mapData = null;
    let mapMarkerClusters = {};

    // ---- Utility functions ----

    function showError(containerId, retryFn) {
        const el = document.getElementById(containerId);
        if (!el) return;
        el.innerHTML = '<div class="text-center py-8 text-gray-400"><p>Unable to load data</p>' +
            (retryFn ? '<button onclick="' + retryFn + '()" class="text-blue-600 text-sm mt-2">Retry</button>' : '') +
            '</div>';
    }

    async function apiFetch(path) {
        const resp = await fetch(API_URL + path);
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        return resp.json();
    }

    function buildLayout(overrides) {
        return Object.assign({}, CHART_LAYOUT_BASE, overrides, {
            xaxis: Object.assign({}, CHART_LAYOUT_BASE.xaxis, overrides.xaxis || {}),
            yaxis: Object.assign({}, CHART_LAYOUT_BASE.yaxis, overrides.yaxis || {}),
        });
    }

    function getDateParams() {
        const s = document.getElementById('startDate').value;
        const e = document.getElementById('endDate').value;
        let params = '';
        if (s) params += '?start_date=' + s;
        if (e) params += (params ? '&' : '?') + 'end_date=' + e;
        return params;
    }

    // ---- Tab switching ----

    function initTabs() {
        const btns = document.querySelectorAll('.tab-btn');
        btns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.getAttribute('data-tab');
                btns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('[data-tab-content]').forEach(el => {
                    el.classList.toggle('hidden', el.getAttribute('data-tab-content') !== tab);
                });
                window.location.hash = tab;
                loadTabData(tab);
            });
        });

        // Restore from hash
        const hash = window.location.hash.replace('#', '');
        if (hash && ['overview', 'trends', 'map', 'insights'].includes(hash)) {
            btns.forEach(b => {
                b.classList.toggle('active', b.getAttribute('data-tab') === hash);
            });
            document.querySelectorAll('[data-tab-content]').forEach(el => {
                el.classList.toggle('hidden', el.getAttribute('data-tab-content') !== hash);
            });
            loadTabData(hash);
        }
    }

    async function loadTabData(tab) {
        if (tabDataLoaded[tab]) return;
        tabDataLoaded[tab] = true;
        switch (tab) {
            case 'overview': await loadOverview(); break;
            case 'trends': await loadTrends(); break;
            case 'map': await loadMap(); break;
            case 'insights': await loadInsights(); break;
        }
    }

    // ---- Overview Tab ----

    async function loadOverview() {
        const [health, categories, stats, timeseries, districtData, recent, resolution, anomaliesData] = await Promise.all([
            apiFetch('/health').catch(() => null),
            apiFetch('/api/categories').catch(() => null),
            apiFetch('/api/data/stats').catch(() => null),
            apiFetch('/api/data/daily-timeseries' + getDateParams()).catch(() => null),
            apiFetch('/api/analytics/district-breakdown').catch(() => null),
            apiFetch('/api/data/recent?limit=10').catch(() => null),
            apiFetch('/api/analytics/resolution-time').catch(() => null),
            apiFetch('/api/analytics/anomalies').catch(() => null),
        ]);

        // Populate category dropdown
        if (categories && categories.categories) {
            categoriesList = categories.categories;
            const select = document.getElementById('globalCategoryFilter');
            select.innerHTML = '<option value="">All Categories</option>' +
                categoriesList.map(c => '<option value="' + c + '">' + c + '</option>').join('');
        }

        // KPI cards
        if (stats) {
            document.getElementById('kpiOpen').textContent = (stats.total_requests || 0).toLocaleString();
        }
        if (resolution && resolution.overall_avg_hours != null) {
            document.getElementById('kpiResolution').textContent = Math.round(resolution.overall_avg_hours) + ' hrs';
        }

        // Anomalies KPI - use server-side anomaly detection
        if (anomaliesData && anomaliesData.anomalies) {
            const anomalies = anomaliesData.anomalies;
            const kpiEl = document.getElementById('kpiAnomalies');
            kpiEl.textContent = anomalies.length;
            kpiEl.className = 'text-2xl font-bold mt-1 ' + (anomalies.length > 0 ? 'text-red-600' : 'text-gray-900');

            if (anomalies.length > 0) {
                document.getElementById('anomalyAlerts').classList.remove('hidden');
                document.getElementById('anomalyList').innerHTML = anomalies.slice(0, 5).map(a => {
                    let html = '<p>' + a.category + ' spiked ' + a.deviation_factor + 'x above normal on ' + a.date +
                        ' (' + a.actual_count + ' vs expected ' + a.expected_count + ')';
                    if (a.possible_event_cause) html += '<br><span class="text-blue-600 text-xs">' + a.possible_event_cause + '</span>';
                    return html + '</p>';
                }).join('');
            }
        } else if (timeseries && timeseries.dates && timeseries.counts) {
            // Fallback: client-side detection from timeseries
            const anomalies = detectAnomalies(timeseries);
            const kpiEl = document.getElementById('kpiAnomalies');
            kpiEl.textContent = anomalies.length;
            kpiEl.className = 'text-2xl font-bold mt-1 ' + (anomalies.length > 0 ? 'text-red-600' : 'text-gray-900');

            if (anomalies.length > 0) {
                document.getElementById('anomalyAlerts').classList.remove('hidden');
                document.getElementById('anomalyList').innerHTML = anomalies.map(a =>
                    '<p>' + a + '</p>'
                ).join('');
            }
        }

        // Volume chart
        if (timeseries && timeseries.dates && timeseries.dates.length > 0) {
            renderVolumeChart(timeseries);
        } else {
            showError('volumeChart', 'loadOverview');
        }

        // Categories chart
        if (stats && stats.top_categories) {
            renderCategoriesChart(stats.top_categories);
        } else if (stats && stats.categories) {
            const top = Object.entries(stats.categories).sort((a, b) => b[1] - a[1]).slice(0, 10);
            renderCategoriesChart(Object.fromEntries(top));
        } else {
            showError('categoriesChart');
        }

        // District chart
        if (districtData && districtData.districts && districtData.districts.length > 0) {
            renderDistrictBreakdown(districtData.districts);
            // Fill busiest district KPI
            const top = districtData.districts[0];
            document.getElementById('kpiBusiest').textContent = top.name;
            document.getElementById('kpiBusiestCount').textContent = top.count.toLocaleString() + ' requests';
        } else {
            showError('districtChart');
        }

        // Recent table
        if (recent && recent.data) {
            renderRecentTable(recent.data);
        } else {
            document.getElementById('recentTable').innerHTML =
                '<tr><td colspan="5" class="py-8 text-center text-gray-400">Unable to load data</td></tr>';
        }
    }

    function detectAnomalies(ts) {
        const counts = ts.counts;
        const dates = ts.dates;
        if (counts.length < 14) return [];

        const recentCounts = counts.slice(-7);
        const prevCounts = counts.slice(-14, -7);
        const prevAvg = prevCounts.reduce((a, b) => a + b, 0) / prevCounts.length;
        const prevStd = Math.sqrt(prevCounts.reduce((s, c) => s + Math.pow(c - prevAvg, 2), 0) / prevCounts.length);

        const anomalies = [];
        recentCounts.forEach((c, i) => {
            if (prevStd > 0 && (c - prevAvg) / prevStd > 2.5) {
                const ratio = (c / prevAvg).toFixed(1);
                const date = dates[dates.length - 7 + i];
                anomalies.push('Volume spiked ' + ratio + 'x above normal on ' + date);
            }
        });
        return anomalies;
    }

    function renderVolumeChart(ts) {
        const eventsByDate = ts.events_by_date || {};
        const hoverText = ts.dates.map((d, i) => {
            const cnt = (ts.counts[i] || 0).toLocaleString();
            const ev = eventsByDate[d];
            if (ev && ev.length) return d + '<br>' + cnt + ' requests<br><b>Events:</b> ' + ev.join(', ');
            return d + '<br>' + cnt + ' requests';
        });
        const trace = {
            x: ts.dates,
            y: ts.counts,
            text: hoverText,
            hoverinfo: 'text',
            type: 'scatter',
            mode: 'lines+markers',
            line: { color: '#2563eb', width: 2 },
            marker: { size: 3, color: '#2563eb' },
        };
        const layout = buildLayout({
            margin: { t: 10, r: 20, b: 40, l: 50 },
            xaxis: { gridcolor: '#f3f4f6', linecolor: '#e5e7eb' },
            yaxis: { gridcolor: '#f3f4f6', linecolor: '#e5e7eb', title: { text: 'Requests', font: { size: 11 } } },
            hovermode: 'closest',
        });
        Plotly.newPlot('volumeChart', [trace], layout, CHART_CONFIG);
    }

    function renderCategoriesChart(cats) {
        const entries = Object.entries(cats).sort((a, b) => a[1] - b[1]);
        const trace = {
            y: entries.map(e => e[0]),
            x: entries.map(e => e[1]),
            type: 'bar',
            orientation: 'h',
            marker: { color: '#2563eb' },
        };
        const layout = buildLayout({
            margin: { t: 10, r: 20, b: 40, l: 180 },
            yaxis: { automargin: true, gridcolor: '#f3f4f6', linecolor: '#e5e7eb' },
            xaxis: { gridcolor: '#f3f4f6', linecolor: '#e5e7eb', title: { text: 'Count', font: { size: 11 } } },
        });
        Plotly.newPlot('categoriesChart', [trace], layout, CHART_CONFIG);
        document.getElementById('categoriesChart').on('plotly_click', (data) => {
            if (data.points && data.points[0] && data.points[0].y) {
                const cat = data.points[0].y;
                document.getElementById('globalCategoryFilter').value = cat;
                updateClearFiltersVisibility();
                tabDataLoaded.map = false;
                loadTabData('map');
                document.querySelector('.tab-btn[data-tab="map"]').click();
            }
        });
    }

    function renderDistrictBreakdown(districts) {
        // districts is array of {district, name, count, percentage} sorted by count desc
        const sorted = [...districts].sort((a, b) => a.count - b.count); // ascending for horizontal bar
        const trace = {
            y: sorted.map(d => 'D' + d.district + ': ' + d.name),
            x: sorted.map(d => d.count),
            type: 'bar',
            orientation: 'h',
            marker: { color: '#2563eb' },
        };
        const layout = buildLayout({
            margin: { t: 10, r: 20, b: 40, l: 180 },
            yaxis: { automargin: true, gridcolor: '#f3f4f6', linecolor: '#e5e7eb' },
            xaxis: { gridcolor: '#f3f4f6', linecolor: '#e5e7eb', title: { text: 'Count', font: { size: 11 } } },
        });
        Plotly.newPlot('districtChart', [trace], layout, CHART_CONFIG);
        const districtMap = {};
        sorted.forEach(d => { districtMap['D' + d.district + ': ' + d.name] = d.district; });
        document.getElementById('districtChart').on('plotly_click', (data) => {
            if (data.points && data.points[0] && data.points[0].y) {
                const label = data.points[0].y;
                const dist = districtMap[label];
                if (dist != null) {
                    document.getElementById('globalDistrictFilter').value = String(dist);
                    updateClearFiltersVisibility();
                    tabDataLoaded.map = false;
                    loadTabData('map');
                    document.querySelector('.tab-btn[data-tab="map"]').click();
                }
            }
        });
    }

    function renderRecentTable(data) {
        const tbody = document.getElementById('recentTable');
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-gray-400">No recent data</td></tr>';
            return;
        }
        tbody.innerHTML = data.slice(0, 10).map(r => {
            const dNum = r.district != null ? Math.floor(r.district) : null;
            const dName = dNum !== null ? (DISTRICT_NAMES[dNum] ? 'D' + dNum + ': ' + DISTRICT_NAMES[dNum] : 'D' + dNum) : '--';
            const statusClass = r.status === 'Closed' ? 'bg-green-50 text-green-700' : 'bg-yellow-50 text-yellow-700';
            return '<tr class="hover:bg-gray-50">' +
                '<td class="py-2 px-3 text-gray-600">' + (r.opened ? new Date(r.opened).toLocaleDateString() : '--') + '</td>' +
                '<td class="py-2 px-3 text-gray-900">' + (r.category || '--') + '</td>' +
                '<td class="py-2 px-3 text-gray-600 max-w-xs truncate">' + (r.address || '--') + '</td>' +
                '<td class="py-2 px-3 text-gray-600">' + dName + '</td>' +
                '<td class="py-2 px-3"><span class="text-xs px-2 py-0.5 rounded-full font-medium ' + statusClass + '">' + (r.status || '--') + '</span></td>' +
                '</tr>';
        }).join('');
    }

    // ---- Trends Tab ----

    async function loadTrends() {
        const params = getDateParams();
        const [dow, hourly, monthly, insights, resolution] = await Promise.all([
            apiFetch('/api/analytics/day-of-week' + params).catch(() => null),
            apiFetch('/api/analytics/hourly-pattern' + params).catch(() => null),
            apiFetch('/api/analytics/monthly-trends' + params).catch(() => null),
            apiFetch('/api/analytics/category-insights').catch(() => null),
            apiFetch('/api/analytics/resolution-time').catch(() => null),
        ]);

        // Day of week
        if (dow && dow.days) {
            const trace = {
                x: dow.days,
                y: dow.counts,
                type: 'bar',
                marker: { color: '#2563eb' },
            };
            const layout = buildLayout({
                margin: { t: 10, r: 20, b: 40, l: 50 },
                yaxis: { gridcolor: '#f3f4f6', linecolor: '#e5e7eb', title: { text: 'Requests', font: { size: 11 } } },
            });
            Plotly.newPlot('dowChart', [trace], layout, CHART_CONFIG);

            const maxDay = dow.days[dow.counts.indexOf(Math.max(...dow.counts))];
            const minDay = dow.days[dow.counts.indexOf(Math.min(...dow.counts))];
            const diff = ((Math.max(...dow.counts) - Math.min(...dow.counts)) / Math.min(...dow.counts) * 100).toFixed(0);
            document.getElementById('dowInsight').textContent =
                maxDay + ' sees ' + diff + '% more requests than ' + minDay + '. Plan heavier staffing early in the week.';
        } else {
            showError('dowChart');
        }

        // Hourly
        if (hourly && hourly.hours) {
            const trace = {
                x: hourly.hours.map(h => h + ':00'),
                y: hourly.counts,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#2563eb', width: 2 },
                marker: { size: 4, color: '#2563eb' },
            };
            const layout = buildLayout({
                margin: { t: 10, r: 20, b: 40, l: 50 },
                yaxis: { gridcolor: '#f3f4f6', linecolor: '#e5e7eb', title: { text: 'Requests', font: { size: 11 } } },
                annotations: [{
                    x: hourly.peak_hour + ':00',
                    y: hourly.peak_count,
                    text: 'Peak: ' + hourly.peak_hour + ':00',
                    showarrow: true, arrowhead: 2, ax: 0, ay: -30,
                    font: { size: 11, color: '#2563eb' },
                }],
            });
            Plotly.newPlot('hourlyChart', [trace], layout, CHART_CONFIG);

            const total = hourly.counts.reduce((a, b) => a + b, 0);
            const morning = hourly.counts.slice(8, 12).reduce((a, b) => a + b, 0);
            const pct = (morning / total * 100).toFixed(0);
            document.getElementById('hourlyInsight').textContent =
                'Peak at ' + hourly.peak_hour + ':00. Morning rush (8-11 AM) accounts for ' + pct + '% of daily volume.';
        } else {
            showError('hourlyChart');
        }

        // Monthly
        if (monthly && monthly.months) {
            const trace = {
                x: monthly.months,
                y: monthly.counts,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#2563eb', width: 2 },
                marker: { size: 5, color: '#2563eb' },
            };
            const avgLine = {
                x: monthly.months,
                y: new Array(monthly.months.length).fill(monthly.average),
                type: 'scatter',
                mode: 'lines',
                line: { color: '#9ca3af', width: 1, dash: 'dash' },
                name: 'Average',
                showlegend: false,
            };
            const layout = buildLayout({
                margin: { t: 10, r: 20, b: 40, l: 60 },
                yaxis: { gridcolor: '#f3f4f6', linecolor: '#e5e7eb', title: { text: 'Requests', font: { size: 11 } } },
                showlegend: false,
            });
            Plotly.newPlot('monthlyChart', [trace, avgLine], layout, CHART_CONFIG);

            const maxIdx = monthly.counts.indexOf(Math.max(...monthly.counts));
            const spike = ((monthly.counts[maxIdx] - monthly.average) / monthly.average * 100).toFixed(0);
            document.getElementById('monthlyInsight').textContent =
                monthly.months[maxIdx] + ' peaked ' + spike + '% above average. Plan extra capacity during seasonal highs.';
        } else {
            showError('monthlyChart');
        }

        // Category growth
        if (insights && insights.category_growth_trends) {
            const trends = insights.category_growth_trends;
            const trace = {
                y: trends.map(t => t.category),
                x: trends.map(t => t.growth_pct),
                type: 'bar',
                orientation: 'h',
                marker: { color: trends.map(t => t.growth_pct < 0 ? '#16a34a' : '#dc2626') },
                text: trends.map(t => (t.growth_pct > 0 ? '+' : '') + t.growth_pct + '%'),
                textposition: 'outside',
                textfont: { size: 11 },
            };
            const layout = buildLayout({
                margin: { t: 10, r: 60, b: 40, l: 200 },
                yaxis: { automargin: true, gridcolor: '#f3f4f6', linecolor: '#e5e7eb' },
                xaxis: { gridcolor: '#f3f4f6', linecolor: '#e5e7eb', zeroline: true, zerolinecolor: '#d1d5db', title: { text: 'Growth %', font: { size: 11 } } },
            });
            Plotly.newPlot('growthChart', [trace], layout, CHART_CONFIG);

            const declining = trends.filter(t => t.growth_pct < 0);
            document.getElementById('growthInsight').textContent =
                declining.length + ' categories declining. ' + (trends[0] ? trends[0].category + ' shows largest change at ' + trends[0].growth_pct + '%.' : '');
        } else {
            showError('growthChart');
        }

        // Resolution time
        if (resolution && resolution.categories && resolution.categories.length > 0) {
            const items = resolution.categories.slice(0, 10);
            const cats = items.map(c => c.category);
            const hours = items.map(c => c.avg_hours);
            const colors = hours.map(h => h > 72 ? '#dc2626' : h > 24 ? '#d97706' : '#16a34a');
            const trace = {
                y: cats,
                x: hours,
                type: 'bar',
                orientation: 'h',
                marker: { color: colors },
                text: hours.map(h => Math.round(h) + 'h'),
                textposition: 'outside',
                textfont: { size: 11 },
            };
            const layout = buildLayout({
                margin: { t: 10, r: 50, b: 40, l: 200 },
                yaxis: { automargin: true, gridcolor: '#f3f4f6', linecolor: '#e5e7eb' },
                xaxis: { gridcolor: '#f3f4f6', linecolor: '#e5e7eb', title: { text: 'Avg Hours to Resolution', font: { size: 11 } } },
            });
            Plotly.newPlot('resolutionChart', [trace], layout, CHART_CONFIG);
        } else {
            showError('resolutionChart');
        }
    }

    // ---- Map Tab ----

    function getMapApiParams() {
        const s = document.getElementById('startDate').value;
        const e = document.getElementById('endDate').value;
        const cat = document.getElementById('globalCategoryFilter').value;
        const dist = document.getElementById('globalDistrictFilter').value;
        let params = [];
        if (s) params.push('start_date=' + s);
        if (e) params.push('end_date=' + e);
        if (cat) params.push('category=' + encodeURIComponent(cat));
        if (dist) params.push('district=' + dist);
        return params.length ? '?' + params.join('&') : '';
    }

    async function loadMap() {
        // Initialize or reuse map
        if (!leafletMap) {
            leafletMap = L.map('mapContainer', { zoomControl: true }).setView([37.7749, -122.4194], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                maxZoom: 19,
            }).addTo(leafletMap);
        } else {
            // Clear existing layers
            Object.values(mapLayerGroups).forEach(lg => {
                if (leafletMap.hasLayer(lg)) leafletMap.removeLayer(lg);
            });
            mapLayerGroups = {};
            mapMarkerClusters = {};
        }

        try {
            const params = getMapApiParams();
            const data = await apiFetch('/api/analytics/map-data' + params);
            mapData = data;
            if (!data || !data.categories || data.categories.length === 0) {
                showMapEmpty();
                return;
            }
            renderMapCategories(data.categories, data.format === 'heatmap');
        } catch (e) {
            showMapEmpty();
        }
    }

    function showMapEmpty() {
        const container = document.getElementById('mapContainer');
        const overlay = document.createElement('div');
        overlay.className = 'absolute inset-0 flex items-center justify-center z-[1000] pointer-events-none';
        overlay.innerHTML = '<div class="bg-white rounded-lg shadow-sm border border-gray-200 px-6 py-4 text-center">' +
            '<p class="text-gray-500 text-sm">No geographic data available</p></div>';
        container.style.position = 'relative';
        container.appendChild(overlay);
    }

    function renderMapCategories(categories, isHeatmap) {
        // categories: {category, points/cells, count, color}
        const colorMap = {};
        categories.forEach(c => { colorMap[c.category] = c.color; });

        const counts = categories.map(c => {
            const items = c.cells || c.points || [];
            return items.reduce((sum, p) => sum + (p.count || 1), 0);
        });
        const maxCount = Math.max(...counts, 1);

        categories.forEach(catObj => {
            if (isHeatmap && catObj.cells && catObj.cells.length > 0) {
                // Heatmap: cells with count - larger radius for higher count
                const lg = L.layerGroup();
                catObj.cells.forEach(cell => {
                    const count = cell.count || 1;
                    const radius = Math.max(4, Math.min(20, 4 + (count / maxCount) * 16));
                    L.circleMarker([cell.lat, cell.lon], {
                        radius,
                        fillColor: catObj.color,
                        color: catObj.color,
                        weight: 0.5,
                        fillOpacity: 0.5,
                    }).bindPopup('<strong>' + catObj.category + '</strong><br>' + count + ' requests')
                      .addTo(lg);
                });
                lg.addTo(leafletMap);
                mapLayerGroups[catObj.category] = lg;
            } else {
                // Points: use MarkerCluster for better performance
                const clusterGroup = L.markerClusterGroup({
                    chunkedLoading: true,
                    spiderfyOnMaxZoom: true,
                    showCoverageOnHover: false,
                });
                (catObj.points || []).forEach(p => {
                    if (p.lat != null && p.lon != null) {
                        const m = L.circleMarker([p.lat, p.lon], {
                            radius: 5,
                            fillColor: catObj.color,
                            color: catObj.color,
                            weight: 0.5,
                            fillOpacity: 0.6,
                        }).bindPopup('<strong>' + catObj.category + '</strong><br>' + p.lat.toFixed(4) + ', ' + p.lon.toFixed(4));
                        clusterGroup.addLayer(m);
                    }
                });
                clusterGroup.addTo(leafletMap);
                mapLayerGroups[catObj.category] = clusterGroup;
                mapMarkerClusters[catObj.category] = clusterGroup;
            }
        });

        // Render toggles
        const toggleContainer = document.getElementById('mapCategoryToggles');
        toggleContainer.innerHTML = '<div class="flex flex-wrap gap-2">' +
            categories.map(c =>
                '<label class="inline-flex items-center gap-1.5 text-xs bg-white border border-gray-200 rounded-full px-3 py-1 cursor-pointer hover:bg-gray-50">' +
                '<input type="checkbox" checked class="sr-only" data-map-cat="' + c.category + '">' +
                '<span class="w-2.5 h-2.5 rounded-full inline-block" style="background:' + c.color + '"></span>' +
                '<span class="text-gray-700">' + c.category + ' (' + c.count + ')</span>' +
                '</label>'
            ).join('') + '</div>';

        toggleContainer.querySelectorAll('input[data-map-cat]').forEach(cb => {
            cb.addEventListener('change', () => {
                const cat = cb.getAttribute('data-map-cat');
                if (cb.checked) {
                    leafletMap.addLayer(mapLayerGroups[cat]);
                    cb.parentElement.classList.remove('opacity-40');
                } else {
                    leafletMap.removeLayer(mapLayerGroups[cat]);
                    cb.parentElement.classList.add('opacity-40');
                }
            });
            cb.parentElement.addEventListener('click', (e) => {
                if (e.target !== cb) {
                    cb.checked = !cb.checked;
                    cb.dispatchEvent(new Event('change'));
                }
            });
        });

        // Legend
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function () {
            const div = L.DomUtil.create('div', 'legend-panel');
            div.innerHTML = '<h4>Categories</h4>' +
                categories.map(c =>
                    '<div class="legend-item"><span class="legend-dot" style="background:' + c.color + '"></span>' + c.category + '</div>'
                ).join('');
            return div;
        };
        legend.addTo(leafletMap);

        // Fix map rendering after tab switch
        setTimeout(() => leafletMap.invalidateSize(), 100);
    }

    // ---- Insights Tab ----

    async function loadInsights() {
        const params = getDateParams();
        const [insights, monthly, eventCorr] = await Promise.all([
            apiFetch('/api/analytics/category-insights').catch(() => null),
            apiFetch('/api/analytics/monthly-trends' + params).catch(() => null),
            apiFetch('/api/analytics/event-correlation' + params).catch(() => null),
        ]);

        // Event correlation
        const ecEl = document.getElementById('eventCorrelation');
        if (eventCorr && eventCorr.event_days_avg_requests != null) {
            const lift = eventCorr.lift_percent != null ? eventCorr.lift_percent : 0;
            const liftColor = lift > 0 ? 'text-red-600' : lift < 0 ? 'text-green-600' : 'text-gray-600';
            const topCats = (eventCorr.top_categories_on_event_days || []).slice(0, 5).map(c => c.category + ' (' + c.count + ')').join(', ') || '—';
            ecEl.innerHTML =
                '<div class="space-y-2">' +
                '<p><span class="font-medium">Avg requests on event days:</span> ' + eventCorr.event_days_avg_requests.toLocaleString() + ' (' + (eventCorr.event_days_count || 0) + ' days)</p>' +
                '<p><span class="font-medium">Avg requests on non-event days:</span> ' + eventCorr.non_event_days_avg_requests.toLocaleString() + ' (' + (eventCorr.non_event_days_count || 0) + ' days)</p>' +
                '<p class="' + liftColor + ' font-medium">' + (lift > 0 ? '↑' : '') + (lift < 0 ? '↓' : '') + (lift !== 0 ? Math.abs(lift) + '%' : '0%') + ' on event days vs non-event days</p>' +
                '<p class="text-xs text-gray-500 mt-2"><span class="font-medium">Top categories on event days:</span> ' + topCats + '</p>' +
                '</div>';
        } else {
            ecEl.innerHTML = '<p class="text-gray-400">' + (eventCorr && eventCorr.message ? eventCorr.message : 'Event data not available. Run: python scripts/fetch_events.py') + '</p>';
        }

        // District Hotspots
        if (insights && insights.district_hotspots && insights.district_hotspots.length > 0) {
            const hotspots = insights.district_hotspots;
            const traces = hotspots.map((h, i) => ({
                y: [h.category],
                x: [h.concentration],
                type: 'bar',
                orientation: 'h',
                name: 'D' + h.district + ' (' + (DISTRICT_NAMES[h.district] || '') + ')',
                marker: { color: MAP_CATEGORY_COLORS[i % MAP_CATEGORY_COLORS.length] },
                text: [h.concentration + '%'],
                textposition: 'outside',
                textfont: { size: 11 },
            }));
            const layout = buildLayout({
                margin: { t: 10, r: 60, b: 40, l: 180 },
                barmode: 'group',
                yaxis: { automargin: true, gridcolor: '#f3f4f6', linecolor: '#e5e7eb' },
                xaxis: { gridcolor: '#f3f4f6', linecolor: '#e5e7eb', title: { text: '% Concentration', font: { size: 11 } } },
                showlegend: true,
                legend: { orientation: 'h', y: 1.12, x: 0.5, xanchor: 'center', font: { size: 11 } },
            });
            Plotly.newPlot('hotspotsChart', traces, layout, CHART_CONFIG);
        } else {
            showError('hotspotsChart');
        }

        // Recommendations
        const recs = [
            { title: 'Staff peak hours proactively', desc: 'Deploy 30% more field crews between 8-11 AM when request volume is highest.' },
            { title: 'Focus on D6 encampments', desc: '33% of encampment requests concentrate in SOMA/Tenderloin. Station dedicated teams there.' },
            { title: 'Reduce weekend crews', desc: 'Weekend volume drops significantly. Reallocate weekend staffing to weekday surge.' },
            { title: 'Pre-position for rain events', desc: 'Sewer and flooding requests spike on rainy days. Monitor weather forecasts to deploy crews early.' },
            { title: 'Graffiti team in D9', desc: '25% of graffiti reports come from Mission/Portola. Assign a dedicated crew to this district.' },
        ];
        document.getElementById('recommendations').innerHTML = recs.map(r =>
            '<div class="bg-white border border-gray-200 rounded-lg p-4">' +
            '<p class="text-sm font-semibold text-gray-900">' + r.title + '</p>' +
            '<p class="text-xs text-gray-500 mt-1">' + r.desc + '</p>' +
            '</div>'
        ).join('');

        // Comparative summary
        if (monthly && monthly.months && monthly.counts && monthly.counts.length >= 2) {
            const len = monthly.counts.length;
            const thisMonth = monthly.counts[len - 1];
            const lastMonth = monthly.counts[len - 2];
            const change = ((thisMonth - lastMonth) / lastMonth * 100).toFixed(1);
            const direction = change >= 0 ? 'up' : 'down';
            const arrow = change >= 0 ? '&#9650;' : '&#9660;';
            const color = change >= 0 ? 'text-red-600' : 'text-green-600';

            document.getElementById('comparativeSummary').innerHTML =
                '<div class="space-y-2">' +
                '<p><span class="font-medium text-gray-900">This month (' + monthly.months[len - 1] + '):</span> ' + thisMonth.toLocaleString() + ' requests</p>' +
                '<p><span class="font-medium text-gray-900">Last month (' + monthly.months[len - 2] + '):</span> ' + lastMonth.toLocaleString() + ' requests</p>' +
                '<p class="' + color + ' font-medium">' + arrow + ' ' + Math.abs(change) + '% ' + direction + ' month-over-month</p>' +
                '</div>';
        } else {
            document.getElementById('comparativeSummary').innerHTML =
                '<p class="text-gray-400 text-center py-4">Not enough data for comparison</p>';
        }

        // Compare periods: this month vs same month last year
        (async () => {
            const now = new Date();
            const thisYear = now.getFullYear();
            const thisMonth = now.getMonth() + 1;
            const baseStart = thisYear + '-' + String(thisMonth).padStart(2, '0') + '-01';
            const lastDay = new Date(thisYear, thisMonth, 0).getDate();
            const baseEnd = thisYear + '-' + String(thisMonth).padStart(2, '0') + '-' + String(lastDay).padStart(2, '0');
            const compStart = (thisYear - 1) + '-' + String(thisMonth).padStart(2, '0') + '-01';
            const compLastDay = new Date(thisYear - 1, thisMonth, 0).getDate();
            const compEnd = (thisYear - 1) + '-' + String(thisMonth).padStart(2, '0') + '-' + String(compLastDay).padStart(2, '0');
            try {
                const cmp = await apiFetch('/api/analytics/compare-periods?base_start=' + baseStart + '&base_end=' + baseEnd + '&compare_start=' + compStart + '&compare_end=' + compEnd);
                if (cmp && cmp.base_period && cmp.compare_period) {
                    const baseTotal = cmp.base_period.total;
                    const compTotal = cmp.compare_period.total;
                    const pct = cmp.change_percent;
                    const color = pct == null ? '' : (pct >= 0 ? 'text-red-600' : 'text-green-600');
                    const arrow = pct == null ? '' : (pct >= 0 ? '&#9650;' : '&#9660;');
                    document.getElementById('comparePeriodsResult').innerHTML =
                        '<div class="space-y-2">' +
                        '<p><span class="font-medium">This month (' + baseStart.slice(0, 7) + '):</span> ' + baseTotal.toLocaleString() + ' requests</p>' +
                        '<p><span class="font-medium">Same month last year (' + compStart.slice(0, 7) + '):</span> ' + compTotal.toLocaleString() + ' requests</p>' +
                        (pct != null ? '<p class="' + color + ' font-medium">' + arrow + ' ' + Math.abs(pct) + '% vs last year</p>' : '<p class="text-gray-500">Insufficient historical data</p>') +
                        '</div>';
                } else {
                    document.getElementById('comparePeriodsResult').innerHTML = '<p class="text-gray-400">Unable to load comparison</p>';
                }
            } catch (e) {
                document.getElementById('comparePeriodsResult').innerHTML = '<p class="text-gray-400">Unable to load comparison</p>';
            }
        })();
    }

    function updateClearFiltersVisibility() {
        const cat = document.getElementById('globalCategoryFilter').value;
        const dist = document.getElementById('globalDistrictFilter').value;
        document.getElementById('clearDrillDown').classList.toggle('hidden', !cat && !dist);
    }

    // ---- Date Range + Category Filter ----

    function initFilters() {
        document.getElementById('applyDateRange').addEventListener('click', () => {
            tabDataLoaded.overview = false;
            tabDataLoaded.trends = false;
            tabDataLoaded.map = false;
            tabDataLoaded.insights = false;
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) loadTabData(activeTab.getAttribute('data-tab'));
        });

        document.getElementById('globalCategoryFilter').addEventListener('change', async (e) => {
            updateClearFiltersVisibility();
            const cat = e.target.value;
            tabDataLoaded.map = false;
            if (cat) {
                try {
                    const data = await apiFetch('/api/analytics/category-timeseries?category=' + encodeURIComponent(cat));
                    if (data && data.dates) {
                        renderVolumeChart(data);
                    }
                } catch (err) {
                    tabDataLoaded.overview = false;
                    loadTabData('overview');
                }
            } else {
                tabDataLoaded.overview = false;
                loadTabData('overview');
            }
        });

        document.getElementById('globalDistrictFilter').addEventListener('change', () => {
            updateClearFiltersVisibility();
            tabDataLoaded.overview = false;
            tabDataLoaded.trends = false;
            tabDataLoaded.map = false;
            tabDataLoaded.insights = false;
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) loadTabData(activeTab.getAttribute('data-tab'));
        });

        document.getElementById('clearDrillDown').addEventListener('click', () => {
            document.getElementById('globalCategoryFilter').value = '';
            document.getElementById('globalDistrictFilter').value = '';
            updateClearFiltersVisibility();
            tabDataLoaded.overview = false;
            tabDataLoaded.trends = false;
            tabDataLoaded.map = false;
            tabDataLoaded.insights = false;
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) loadTabData(activeTab.getAttribute('data-tab'));
        });

        document.getElementById('exportCsv').addEventListener('click', () => {
            window.location.href = API_URL + '/api/data/export';
        });
    }

    // ---- Init ----

    document.addEventListener('DOMContentLoaded', () => {
        initTabs();
        initFilters();

        // Load default tab
        const hash = window.location.hash.replace('#', '');
        const activeTab = ['overview', 'trends', 'map', 'insights'].includes(hash) ? hash : 'overview';
        loadTabData(activeTab);
    });
    </script>
</body>
</html>
