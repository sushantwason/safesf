<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>San Francisco Insights</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ["'Plus Jakarta Sans'", 'system-ui', 'sans-serif'] },
                }
            }
        }
    </script>
    <!-- Leaflet loaded lazily when Map tab is opened (see loadMapScripts()) -->
    <style>
        :root {
            --font-sans: 'Plus Jakarta Sans', system-ui, sans-serif;

            /* Premium Dark Palette */
            --surface: #0c111b;
            --surface-elevated: #131a2b;
            --card: #171f31;
            --card-hover: #1c2540;
            --card-border: rgba(255,255,255,0.06);
            --card-border-hover: rgba(255,255,255,0.12);

            /* Accent colors */
            --accent: #f0b429;
            --accent-muted: rgba(240,180,41,0.15);
            --accent-hover: #f7c948;
            --blue: #4c9aff;
            --blue-muted: rgba(76,154,255,0.12);
            --green: #36d399;
            --green-muted: rgba(54,211,153,0.12);
            --red: #f87171;
            --red-muted: rgba(248,113,113,0.12);
            --amber: #fbbf24;
            --purple: #a78bfa;
            --teal: #2dd4bf;
            --rose: #fb7185;

            /* Text hierarchy */
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-tertiary: #64748b;
            --text-on-accent: #0c111b;

            /* Shadows & radius */
            --radius: 14px;
            --radius-sm: 10px;
            --radius-xs: 6px;
            --shadow: 0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.2);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.4), 0 2px 8px rgba(0,0,0,0.3);

            /* Glass effect */
            --glass-bg: rgba(23,31,49,0.7);
            --glass-border: rgba(255,255,255,0.08);
            --glass-blur: 12px;

            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Reset & base */
        * { box-sizing: border-box; }
        body {
            font-family: var(--font-sans);
            background: var(--surface);
            color: var(--text-secondary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Subtle dot-grid background */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: -1;
            background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 24px 24px;
            pointer-events: none;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        /* Card system */
        .card-premium {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast), transform var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        .card-premium:hover {
            border-color: var(--card-border-hover);
            box-shadow: var(--shadow-lg);
            transform: translateY(-1px);
        }
        .card-premium::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(240,180,41,0.3), transparent);
            opacity: 0;
            transition: opacity var(--transition-smooth);
        }
        .card-premium:hover::before { opacity: 1; }

        /* Navigation tabs */
        .tab-btn {
            padding: 7px 16px;
            border-radius: 999px;
            transition: all var(--transition-smooth);
            font-weight: 500;
            font-size: 13px;
            letter-spacing: 0.01em;
            color: var(--text-tertiary);
            cursor: pointer;
            border: none;
            background: transparent;
        }
        .tab-btn:hover {
            color: var(--text-primary);
            background: rgba(255,255,255,0.05);
        }
        .tab-btn.active {
            color: var(--text-on-accent);
            background: var(--accent);
            box-shadow: 0 2px 8px rgba(240,180,41,0.25);
            font-weight: 600;
        }

        /* KPI cards */
        .kpi-card {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px 24px;
            position: relative;
            overflow: hidden;
            transition: all var(--transition-smooth);
        }
        .kpi-card:hover {
            border-color: var(--card-border-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        .kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }
        .kpi-label {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: var(--text-tertiary);
            margin-bottom: 6px;
        }
        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
            line-height: 1.1;
        }
        .kpi-card::after {
            content: '';
            position: absolute;
            top: -20px; right: -20px;
            width: 80px; height: 80px;
            border-radius: 50%;
            opacity: 0.06;
            pointer-events: none;
        }
        .kpi-card:nth-child(1)::after { background: var(--blue); }
        .kpi-card:nth-child(2)::after { background: var(--green); }
        .kpi-card:nth-child(3)::after { background: var(--red); }
        .kpi-card:nth-child(4)::after { background: var(--accent); }

        /* Table */
        .premium-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 13px;
        }
        .premium-table thead th {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-tertiary);
            padding: 10px 16px;
            text-align: left;
            border-bottom: 1px solid var(--card-border);
            background: var(--surface-elevated);
        }
        .premium-table tbody tr { transition: background var(--transition-fast); }
        .premium-table tbody tr:nth-child(even) { background: rgba(255,255,255,0.015); }
        .premium-table tbody tr:hover { background: rgba(76,154,255,0.04); }
        .premium-table tbody td {
            padding: 10px 16px;
            color: var(--text-secondary);
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }

        /* Status badges */
        .status-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .status-badge::before {
            content: '';
            width: 6px; height: 6px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-badge.closed { color: var(--green); background: var(--green-muted); }
        .status-badge.closed::before { background: var(--green); }
        .status-badge.open { color: var(--amber); background: var(--accent-muted); }
        .status-badge.open::before { background: var(--amber); }

        /* Chart headers */
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.01em;
        }
        .chart-subtitle {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        /* Filter bar glass */
        .filter-bar {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border-bottom: 1px solid var(--glass-border);
        }

        /* Inputs */
        .input-premium {
            font-size: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-xs);
            padding: 6px 10px;
            color: var(--text-primary);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
            outline: none;
        }
        .input-premium:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(240,180,41,0.15);
        }
        .input-premium option { background: var(--card); color: var(--text-primary); }

        /* Buttons */
        .btn-primary {
            font-size: 12px;
            font-weight: 600;
            background: var(--accent);
            color: var(--text-on-accent);
            border: none;
            border-radius: var(--radius-xs);
            padding: 6px 14px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .btn-primary:hover {
            background: var(--accent-hover);
            box-shadow: 0 2px 8px rgba(240,180,41,0.3);
            transform: translateY(-1px);
        }

        /* Anomaly alert */
        .anomaly-alert {
            background: var(--red-muted);
            border: 1px solid rgba(248,113,113,0.2);
            border-radius: var(--radius);
            padding: 16px 20px;
            border-left: 3px solid var(--red);
        }
        .anomaly-alert .alert-title {
            color: var(--red);
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Skeleton animation */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.03) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.03) 75%);
            background-size: 200% 100%;
            animation: shimmer 2s ease-in-out infinite;
            border-radius: var(--radius-xs);
        }
        .skeleton-value { height: 32px; width: 40%; margin: 8px 0; }
        .skeleton-chart { height: 280px; width: 100%; }

        /* Tab fade-in */
        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        [data-tab-content]:not(.hidden) {
            animation: fadeSlideUp 0.4s ease-out;
        }

        /* Map */
        #mapContainer { height: calc(100vh - 160px); min-height: 500px; border-radius: var(--radius); overflow: hidden; }
        .leaflet-container { background: var(--surface-elevated); }
        .legend-panel {
            background: var(--card);
            padding: 14px 18px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--card-border);
            max-height: 300px;
            overflow-y: auto;
        }
        .legend-panel h4 { margin: 0 0 10px 0; font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-tertiary); padding: 3px 0; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

        /* Map toggle chips */
        .map-toggle-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 999px;
            padding: 5px 14px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .map-toggle-chip:hover { border-color: var(--card-border-hover); background: var(--card-hover); }
        .map-toggle-chip.disabled { opacity: 0.35; }

        /* Footer */
        .footer-premium {
            background: var(--surface-elevated);
            border-top: 1px solid var(--card-border);
            padding: 20px 0;
        }
        .footer-link {
            font-size: 12px;
            color: var(--text-tertiary);
            transition: color var(--transition-fast);
            text-decoration: none;
            cursor: pointer;
            background: none;
            border: none;
        }
        .footer-link:hover { color: var(--accent); }

        /* Logo */
        .logo-wrap { display: flex; align-items: center; gap: 10px; }
        .logo-bridge { width: 36px; height: 28px; flex-shrink: 0; }
    </style>
</head>
<body class="antialiased">
    <!-- Fixed Top Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-50 h-14" style="background:rgba(10,15,26,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.06);">
        <div class="max-w-7xl mx-auto px-5 h-full flex items-center justify-between">
            <div class="logo-wrap">
                <svg class="logo-bridge" viewBox="0 0 48 28" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <rect x="8" y="8" width="3" height="14" rx="1" fill="#f0b429"/>
                    <rect x="37" y="8" width="3" height="14" rx="1" fill="#f0b429"/>
                    <path d="M11 10 Q24 2 37 10" stroke="#f0b429" stroke-width="2.2" fill="none" stroke-linecap="round"/>
                    <path d="M0 24 L48 24 L48 28 L0 28 Z" fill="#334155"/>
                </svg>
                <span class="font-bold text-lg text-white tracking-tight">San Francisco<span class="mx-1" style="color:#f0b429">/</span>Insights</span>
            </div>
            <div class="flex items-center gap-1">
                <button class="tab-btn active" data-tab="overview">Overview</button>
                <button class="tab-btn" data-tab="trends">Trends</button>
                <button class="tab-btn" data-tab="map">Map</button>
                <button class="tab-btn" data-tab="insights">Insights</button>
                <button class="tab-btn" data-tab="compare">Compare</button>
            </div>
            <div class="flex items-center gap-2">
                <input type="date" id="startDate" class="input-premium">
                <span class="text-[10px] font-medium" style="color:rgba(255,255,255,0.3)">to</span>
                <input type="date" id="endDate" class="input-premium">
                <button id="applyDateRange" class="btn-primary">Apply</button>
            </div>
        </div>
    </nav>

    <!-- Category + District Filter Bar -->
    <div class="fixed top-14 left-0 right-0 z-40 filter-bar h-11">
        <div class="max-w-7xl mx-auto px-5 h-full flex items-center gap-4">
            <label class="text-[11px] font-semibold uppercase tracking-wider" style="color:rgba(255,255,255,0.4)">Category</label>
            <select id="globalCategoryFilter" class="input-premium">
                <option value="">All Categories</option>
            </select>
            <label class="text-[11px] font-semibold uppercase tracking-wider ml-2" style="color:rgba(255,255,255,0.4)">District</label>
            <select id="globalDistrictFilter" class="input-premium">
                <option value="">All Districts</option>
                <option value="1">D1 Richmond</option>
                <option value="2">D2 Marina, Cow Hollow</option>
                <option value="3">D3 North Beach, Chinatown</option>
                <option value="4">D4 Sunset</option>
                <option value="5">D5 Haight, Fillmore</option>
                <option value="6">D6 SOMA, Tenderloin</option>
                <option value="7">D7 Mission, Bernal</option>
                <option value="8">D8 Castro, Noe Valley</option>
                <option value="9">D9 Mission, Portola</option>
                <option value="10">D10 Potrero, Bayview</option>
                <option value="11">D11 Excelsior, Outer Mission</option>
            </select>
            <button id="clearDrillDown" class="text-xs font-semibold hidden" style="color:var(--accent)">Clear filters</button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="pt-28 max-w-7xl mx-auto px-5 pb-20">

        <!-- Tab: Overview -->
        <div data-tab-content="overview">
            <!-- KPI Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-5 mb-8">
                <div class="kpi-card">
                    <div class="kpi-icon" style="background:var(--blue-muted);color:var(--blue);">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    </div>
                    <p class="kpi-label">Open Requests</p>
                    <p class="kpi-value" id="kpiOpen">--</p>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background:var(--green-muted);color:var(--green);">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                    <p class="kpi-label">Avg Resolution</p>
                    <p class="kpi-value" id="kpiResolution">-- hrs</p>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background:var(--red-muted);color:var(--red);">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                    <p class="kpi-label">Anomalies This Week</p>
                    <p class="kpi-value" id="kpiAnomalies">--</p>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background:var(--accent-muted);color:var(--accent);">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    </div>
                    <p class="kpi-label">Busiest District</p>
                    <p class="kpi-value" id="kpiBusiest">--</p>
                    <p class="text-[11px] mt-1" style="color:var(--text-tertiary)" id="kpiBusiestCount"></p>
                </div>
            </div>

            <!-- Anomaly Alerts -->
            <div id="anomalyAlerts" class="hidden mb-8">
                <div class="anomaly-alert">
                    <p class="alert-title">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Anomalies Detected
                    </p>
                    <div id="anomalyList" class="text-[13px] leading-relaxed" style="color:#fca5a5"></div>
                </div>
            </div>

            <!-- Volume Over Time -->
            <div class="card-premium p-6 mb-8">
                <h3 class="chart-title mb-4">Request Volume Over Time</h3>
                <div id="volumeChart" style="height:320px;"></div>
            </div>

            <!-- Resolution insights -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-8">
                <div class="card-premium p-6">
                    <h3 class="chart-title">Resolution time by request type</h3>
                    <p class="chart-subtitle mb-4">Avg hours to close by category</p>
                    <div id="resolutionByCategoryChart" style="height:280px;"></div>
                    <div id="resolutionSlowestFastest" class="text-xs mt-3 space-y-1" style="color:var(--text-tertiary)"></div>
                </div>
                <div class="card-premium p-6">
                    <h3 class="chart-title">Resolution time by time of request</h3>
                    <p class="chart-subtitle mb-4">Avg hours to close by hour when request was opened</p>
                    <div id="resolutionByHourChart" style="height:280px;"></div>
                </div>
            </div>

            <!-- Categories + Districts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-8">
                <div class="card-premium p-6">
                    <h3 class="chart-title mb-4">Top Request Categories</h3>
                    <div id="categoriesChart" style="height:380px;"></div>
                </div>
                <div class="card-premium p-6">
                    <h3 class="chart-title mb-4">Requests by District</h3>
                    <div id="districtChart" style="height:380px;"></div>
                </div>
            </div>

            <!-- Recent Activity Table -->
            <div class="card-premium p-6">
                <h3 class="chart-title mb-5">Recent Activity</h3>
                <div class="overflow-x-auto rounded-lg" style="border:1px solid rgba(255,255,255,0.04)">
                    <table class="premium-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Address</th>
                                <th>District</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentTable">
                            <tr><td colspan="5" class="py-10 text-center"><div class="skeleton skeleton-chart" style="height:200px"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Trends -->
        <div data-tab-content="trends" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-8">
                <div class="card-premium p-6">
                    <h3 class="chart-title mb-4">Day of Week Pattern</h3>
                    <div id="dowChart" style="height:300px;"></div>
                    <p class="text-xs mt-3" style="color:var(--text-tertiary)" id="dowInsight"></p>
                </div>
                <div class="card-premium p-6">
                    <h3 class="chart-title mb-4">Hourly Pattern</h3>
                    <div id="hourlyChart" style="height:300px;"></div>
                    <p class="text-xs mt-3" style="color:var(--text-tertiary)" id="hourlyInsight"></p>
                </div>
            </div>

            <div class="card-premium p-6 mb-8">
                <h3 class="chart-title mb-4">Monthly Trends &amp; Seasonality</h3>
                <div id="monthlyChart" style="height:320px;"></div>
                <p class="text-xs mt-3" style="color:var(--text-tertiary)" id="monthlyInsight"></p>
            </div>

            <div class="card-premium p-6 mb-8">
                <h3 class="chart-title mb-4">Category Growth Trends</h3>
                <div id="growthChart" style="height:360px;"></div>
                <p class="text-xs mt-3" style="color:var(--text-tertiary)" id="growthInsight"></p>
            </div>

            <div class="card-premium p-6">
                <h3 class="chart-title mb-4">Resolution Time Analysis</h3>
                <div id="resolutionChart" style="height:360px;"></div>
            </div>
        </div>

        <!-- Tab: Map -->
        <div data-tab-content="map" class="hidden">
            <div class="mb-3" id="mapCategoryToggles"></div>
            <div class="card-premium overflow-hidden relative">
                <div id="mapContainer">
                    <div id="mapLoading" class="absolute inset-0 flex items-center justify-center z-[400]" style="background:var(--surface-elevated);color:var(--text-tertiary)">
                        <div class="text-center">
                            <div class="skeleton" style="width:48px;height:48px;border-radius:50%;margin:0 auto 12px"></div>
                            <p class="text-sm">Loading map data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Insights -->
        <div data-tab-content="insights" class="hidden">
            <div class="card-premium p-6 mb-8">
                <h3 class="chart-title mb-1">311 Volume vs City Events (DataSF)</h3>
                <p class="chart-subtitle mb-4">Correlates request volume with Our415 events and street closures</p>
                <div id="eventCorrelation" class="text-sm" style="color:var(--text-secondary)">
                    <p style="color:var(--text-tertiary)">Loading...</p>
                </div>
            </div>

            <div class="card-premium p-6 mb-8">
                <h3 class="chart-title mb-4">District Hotspots by Category</h3>
                <div id="hotspotsChart" style="height:300px;"></div>
            </div>

            <div class="card-premium p-6 mb-8">
                <h3 class="chart-title mb-4">Top Actionable Recommendations</h3>
                <div id="recommendations" class="space-y-3">
                    <div class="skeleton skeleton-chart" style="height:120px"></div>
                </div>
            </div>

            <div class="card-premium p-6 mb-8">
                <h3 class="chart-title mb-4">Comparative Period Summary</h3>
                <div id="comparativeSummary" class="text-sm" style="color:var(--text-secondary)">
                    <p class="text-center py-4" style="color:var(--text-tertiary)">Loading...</p>
                </div>
            </div>

            <div class="card-premium p-6">
                <h3 class="chart-title mb-1">Compare Periods</h3>
                <p class="chart-subtitle mb-4">Compare this month to the same month last year</p>
                <div id="comparePeriodsResult" class="text-sm" style="color:var(--text-secondary)">
                    <p style="color:var(--text-tertiary)">Loading...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Tab: Compare -->
    <div data-tab-content="compare" class="hidden">
        <div class="max-w-7xl mx-auto px-5">
            <div class="card-premium p-6 mb-8">
                <h3 class="chart-title mb-1">Compare 311 with another dataset</h3>
                <p class="chart-subtitle mb-4">See how 311 request volume correlates with events or SFPD incident reports.</p>
                <div class="flex items-center gap-4 mb-4">
                    <label class="text-xs font-semibold" style="color:var(--text-tertiary)">Secondary dataset:</label>
                    <select id="compareDataset" class="input-premium">
                        <option value="events">Events (Our415, closures, permits)</option>
                        <option value="crime">SFPD incidents (crime)</option>
                    </select>
                    <button id="runCompare" class="btn-primary">Update</button>
                </div>
                <div id="compareResult" class="text-sm min-h-[120px]" style="color:var(--text-secondary)">
                    <p style="color:var(--text-tertiary)">Click Update to load correlation.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer-premium mt-12">
        <div class="max-w-7xl mx-auto px-5">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <svg viewBox="0 0 48 28" fill="none" style="width:24px;height:18px;opacity:0.4;">
                        <rect x="8" y="8" width="3" height="14" rx="1" fill="#f0b429"/>
                        <rect x="37" y="8" width="3" height="14" rx="1" fill="#f0b429"/>
                        <path d="M11 10 Q24 2 37 10" stroke="#f0b429" stroke-width="2.2" fill="none"/>
                    </svg>
                    <p class="text-[11px]" style="color:var(--text-tertiary)" id="dataFreshness">SF 311 Data &middot; data.sfgov.org</p>
                </div>
                <div class="flex items-center gap-6">
                    <button id="exportCsv" class="footer-link font-medium flex items-center gap-1.5">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Export CSV
                    </button>
                    <a href="/docs" class="footer-link flex items-center gap-1.5">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
                        API Docs
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script>
    const API_URL = window.location.origin;

    const DISTRICT_NAMES = {
        1: 'Richmond', 2: 'Marina, Cow Hollow', 3: 'North Beach, Chinatown',
        4: 'Sunset', 5: 'Haight-Ashbury, Fillmore', 6: 'SOMA, Tenderloin',
        7: 'Mission, Bernal Heights', 8: 'Castro, Noe Valley', 9: 'Mission, Portola',
        10: 'Potrero Hill, Bayview', 11: 'Excelsior, Outer Mission'
    };

    const CHART_CONFIG = { responsive: true, displayModeBar: false };
    const CHART_LAYOUT_BASE = {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: {
            family: "'Plus Jakarta Sans', system-ui, sans-serif",
            size: 12,
            color: '#94a3b8',
        },
        margin: { t: 10, r: 20, b: 50, l: 60 },
        xaxis: {
            gridcolor: 'rgba(255,255,255,0.04)',
            linecolor: 'rgba(255,255,255,0.06)',
            zerolinecolor: 'rgba(255,255,255,0.06)',
            tickfont: { color: '#64748b', size: 11 },
        },
        yaxis: {
            gridcolor: 'rgba(255,255,255,0.04)',
            linecolor: 'rgba(255,255,255,0.06)',
            zerolinecolor: 'rgba(255,255,255,0.06)',
            tickfont: { color: '#64748b', size: 11 },
        },
        hoverlabel: {
            bgcolor: '#1e293b',
            bordercolor: 'rgba(255,255,255,0.1)',
            font: { family: "'Plus Jakarta Sans', system-ui, sans-serif", size: 12, color: '#f1f5f9' },
        },
    };

    const PREMIUM_COLORS = [
        '#4c9aff', '#f0b429', '#36d399', '#fb7185', '#a78bfa',
        '#2dd4bf', '#fbbf24', '#f472b6', '#38bdf8', '#c084fc',
        '#34d399', '#fb923c', '#e879f9', '#22d3ee', '#a3e635',
        '#f43f5e', '#818cf8', '#fdba74', '#67e8f9', '#86efac',
    ];
    const MAP_CATEGORY_COLORS = PREMIUM_COLORS;

    // State
    let categoriesList = [];
    let tabDataLoaded = { overview: false, trends: false, map: false, insights: false };
    let leafletMap = null;
    let mapScriptsLoaded = false;
    let mapScriptsPromise = null;
    let mapLayerGroups = {};
    let mapData = null;
    let mapMarkerClusters = {};

    // ---- Utility functions ----

    function showError(containerId, retryFn) {
        const el = document.getElementById(containerId);
        if (!el) return;
        el.innerHTML = '<div class="text-center py-10" style="color:var(--text-tertiary)">' +
            '<svg class="mx-auto mb-3" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="opacity:0.4"><path d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' +
            '<p class="text-sm">Unable to load data</p>' +
            (retryFn ? '<button onclick="' + retryFn + '()" class="text-sm mt-2 font-medium" style="color:var(--accent)">Retry</button>' : '') +
            '</div>';
    }

    function showSkeleton(ids) {
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = '<div class="skeleton skeleton-chart"></div>';
        });
    }

    async function apiFetch(path) {
        const resp = await fetch(API_URL + path);
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        return resp.json();
    }

    function buildLayout(overrides) {
        return Object.assign({}, CHART_LAYOUT_BASE, overrides, {
            xaxis: Object.assign({}, CHART_LAYOUT_BASE.xaxis, overrides.xaxis || {}),
            yaxis: Object.assign({}, CHART_LAYOUT_BASE.yaxis, overrides.yaxis || {}),
        });
    }

    function getDateParams() {
        const s = document.getElementById('startDate').value;
        const e = document.getElementById('endDate').value;
        let params = '';
        if (s) params += '?start_date=' + s;
        if (e) params += (params ? '&' : '?') + 'end_date=' + e;
        return params;
    }

    // ---- Tab switching ----

    function initTabs() {
        const btns = document.querySelectorAll('.tab-btn');
        btns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.getAttribute('data-tab');
                btns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('[data-tab-content]').forEach(el => {
                    el.classList.toggle('hidden', el.getAttribute('data-tab-content') !== tab);
                });
                window.location.hash = tab;
                loadTabData(tab);
            });
        });

        const hash = window.location.hash.replace('#', '');
        if (hash && ['overview', 'trends', 'map', 'insights', 'compare'].includes(hash)) {
            btns.forEach(b => {
                b.classList.toggle('active', b.getAttribute('data-tab') === hash);
            });
            document.querySelectorAll('[data-tab-content]').forEach(el => {
                el.classList.toggle('hidden', el.getAttribute('data-tab-content') !== hash);
            });
            loadTabData(hash);
        }
    }

    async function loadTabData(tab) {
        if (tabDataLoaded[tab]) return;
        tabDataLoaded[tab] = true;
        switch (tab) {
            case 'overview': await loadOverview(); break;
            case 'trends': await loadTrends(); break;
            case 'map': await loadMap(); break;
            case 'insights': await loadInsights(); break;
            case 'compare': await loadCompare(); break;
        }
    }

    // ---- Overview Tab ----

    async function loadOverview() {
        // Show skeletons
        showSkeleton(['volumeChart','categoriesChart','districtChart','resolutionByCategoryChart','resolutionByHourChart']);
        ['kpiOpen','kpiResolution','kpiAnomalies','kpiBusiest'].forEach(id => {
            const el = document.getElementById(id);
            if (el && (el.textContent === '--' || el.textContent === '-- hrs')) {
                el.innerHTML = '<div class="skeleton skeleton-value"></div>';
            }
        });

        const [health, categories, stats, timeseries, districtData, recent, resolution, resolutionByHour, anomaliesData] = await Promise.all([
            apiFetch('/health').catch(() => null),
            apiFetch('/api/categories').catch(() => null),
            apiFetch('/api/data/stats').catch(() => null),
            apiFetch('/api/data/daily-timeseries' + getDateParams()).catch(() => null),
            apiFetch('/api/analytics/district-breakdown').catch(() => null),
            apiFetch('/api/data/recent?limit=10').catch(() => null),
            apiFetch('/api/analytics/resolution-time').catch(() => null),
            apiFetch('/api/analytics/resolution-by-hour-opened').catch(() => null),
            apiFetch('/api/analytics/anomalies').catch(() => null),
        ]);

        // Populate category dropdown
        if (categories && categories.categories) {
            categoriesList = categories.categories;
            const select = document.getElementById('globalCategoryFilter');
            select.innerHTML = '<option value="">All Categories</option>' +
                categoriesList.map(c => '<option value="' + c + '">' + c + '</option>').join('');
        }

        // KPI cards
        if (stats) {
            document.getElementById('kpiOpen').textContent = (stats.total_requests || 0).toLocaleString();
        }
        if (resolution && resolution.overall_avg_hours != null) {
            document.getElementById('kpiResolution').textContent = Math.round(resolution.overall_avg_hours) + ' hrs';
        }

        // Anomalies KPI
        if (anomaliesData && anomaliesData.anomalies) {
            const anomalies = anomaliesData.anomalies;
            const kpiEl = document.getElementById('kpiAnomalies');
            kpiEl.textContent = anomalies.length;
            kpiEl.style.color = anomalies.length > 0 ? 'var(--red)' : 'var(--text-primary)';

            if (anomalies.length > 0) {
                document.getElementById('anomalyAlerts').classList.remove('hidden');
                document.getElementById('anomalyList').innerHTML = anomalies.slice(0, 5).map(a => {
                    let html = '<p>' + a.category + ' spiked ' + a.deviation_factor + 'x above normal on ' + a.date +
                        ' (' + a.actual_count + ' vs expected ' + a.expected_count + ')';
                    if (a.possible_event_cause) html += '<br><span style="color:var(--blue);font-size:12px">' + a.possible_event_cause + '</span>';
                    return html + '</p>';
                }).join('');
            }
        } else if (timeseries && timeseries.dates && timeseries.counts) {
            const anomalies = detectAnomalies(timeseries);
            const kpiEl = document.getElementById('kpiAnomalies');
            kpiEl.textContent = anomalies.length;
            kpiEl.style.color = anomalies.length > 0 ? 'var(--red)' : 'var(--text-primary)';

            if (anomalies.length > 0) {
                document.getElementById('anomalyAlerts').classList.remove('hidden');
                document.getElementById('anomalyList').innerHTML = anomalies.map(a =>
                    '<p>' + a + '</p>'
                ).join('');
            }
        }

        // Volume chart
        if (timeseries && timeseries.dates && timeseries.dates.length > 0) {
            renderVolumeChart(timeseries);
        } else {
            showError('volumeChart', 'loadOverview');
        }

        // Categories chart
        if (stats && stats.top_categories) {
            renderCategoriesChart(stats.top_categories);
        } else if (stats && stats.categories) {
            const top = Object.entries(stats.categories).sort((a, b) => b[1] - a[1]).slice(0, 10);
            renderCategoriesChart(Object.fromEntries(top));
        } else {
            showError('categoriesChart');
        }

        // District chart
        if (districtData && districtData.districts && districtData.districts.length > 0) {
            renderDistrictBreakdown(districtData.districts);
            const top = districtData.districts[0];
            document.getElementById('kpiBusiest').textContent = top.name;
            document.getElementById('kpiBusiestCount').textContent = top.count.toLocaleString() + ' requests';
        } else {
            showError('districtChart');
        }

        // Resolution by category
        if (resolution && resolution.categories && resolution.categories.length > 0) {
            renderResolutionByCategory(resolution);
        } else {
            const el = document.getElementById('resolutionSlowestFastest');
            if (el) el.innerHTML = '<p style="color:var(--text-tertiary)">No resolution data</p>';
        }
        if (resolutionByHour && resolutionByHour.by_hour && resolutionByHour.by_hour.length > 0) {
            renderResolutionByHour(resolutionByHour.by_hour);
        } else {
            const hourEl = document.getElementById('resolutionByHourChart');
            if (hourEl) hourEl.innerHTML = '<div class="flex items-center justify-center h-full text-sm" style="color:var(--text-tertiary)">No resolution-by-hour data</div>';
        }

        // Recent table
        if (recent && recent.data) {
            renderRecentTable(recent.data);
        } else {
            document.getElementById('recentTable').innerHTML =
                '<tr><td colspan="5" class="py-10 text-center" style="color:var(--text-tertiary)">Unable to load data</td></tr>';
        }
    }

    function detectAnomalies(ts) {
        const counts = ts.counts;
        const dates = ts.dates;
        if (counts.length < 14) return [];

        const recentCounts = counts.slice(-7);
        const prevCounts = counts.slice(-14, -7);
        const prevAvg = prevCounts.reduce((a, b) => a + b, 0) / prevCounts.length;
        const prevStd = Math.sqrt(prevCounts.reduce((s, c) => s + Math.pow(c - prevAvg, 2), 0) / prevCounts.length);

        const anomalies = [];
        recentCounts.forEach((c, i) => {
            if (prevStd > 0 && (c - prevAvg) / prevStd > 2.5) {
                const ratio = (c / prevAvg).toFixed(1);
                const date = dates[dates.length - 7 + i];
                anomalies.push('Volume spiked ' + ratio + 'x above normal on ' + date);
            }
        });
        return anomalies;
    }

    function renderVolumeChart(ts) {
        const eventsByDate = ts.events_by_date || {};
        const weatherByDate = ts.weather_by_date || {};
        const hoverText = ts.dates.map((d, i) => {
            const cnt = (ts.counts[i] || 0).toLocaleString();
            let line = d + '<br>' + cnt + ' requests';
            const ev = eventsByDate[d];
            if (ev && ev.length) line += '<br><b>Events:</b> ' + ev.join(', ');
            const w = weatherByDate[d];
            if (w && (w.precip_mm > 0 || w.rain_day)) line += '<br><b>Rain:</b> ' + (w.precip_mm != null ? w.precip_mm.toFixed(1) + ' mm' : 'yes');
            return line;
        });
        const trace = {
            x: ts.dates,
            y: ts.counts,
            text: hoverText,
            hoverinfo: 'text',
            type: 'scatter',
            mode: 'lines',
            line: { color: '#4c9aff', width: 2.5, shape: 'spline', smoothing: 1.3 },
            fill: 'tozeroy',
            fillcolor: 'rgba(76,154,255,0.08)',
            name: '311 requests',
        };
        const shapes = [];
        ts.dates.forEach((d, i) => {
            const w = weatherByDate[d];
            if (w && (w.rain_day === 1 || (w.precip_mm != null && w.precip_mm > 0.1))) {
                const x0 = i - 0.5;
                const x1 = i + 0.5;
                shapes.push({ type: 'rect', xref: 'x', yref: 'paper', x0, x1, y0: 0, y1: 1, fillcolor: 'rgba(76,154,255,0.04)', line: { width: 0 } });
            }
        });
        const layout = buildLayout({
            margin: { t: 10, r: 20, b: 40, l: 50 },
            xaxis: { gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)' },
            yaxis: { gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)', title: { text: 'Requests', font: { size: 11, color: '#64748b' } } },
            hovermode: 'closest',
            shapes,
            annotations: shapes.length ? [{
                xref: 'paper', yref: 'paper', x: 1, y: 1.02, xanchor: 'right', yanchor: 'bottom',
                text: 'Light blue = rain days', showarrow: false, font: { size: 10, color: '#64748b' },
            }] : [],
        });
        Plotly.newPlot('volumeChart', [trace], layout, CHART_CONFIG);
    }

    function renderCategoriesChart(cats) {
        const entries = Object.entries(cats).sort((a, b) => a[1] - b[1]);
        const trace = {
            y: entries.map(e => e[0]),
            x: entries.map(e => e[1]),
            type: 'bar',
            orientation: 'h',
            marker: { color: '#4c9aff', opacity: 0.85 },
        };
        const layout = buildLayout({
            margin: { t: 10, r: 20, b: 40, l: 180 },
            yaxis: { automargin: true, gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)' },
            xaxis: { gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)', title: { text: 'Count', font: { size: 11, color: '#64748b' } } },
        });
        Plotly.newPlot('categoriesChart', [trace], layout, CHART_CONFIG);
        document.getElementById('categoriesChart').on('plotly_click', (data) => {
            if (data.points && data.points[0] && data.points[0].y) {
                const cat = data.points[0].y;
                document.getElementById('globalCategoryFilter').value = cat;
                updateClearFiltersVisibility();
                tabDataLoaded.map = false;
                loadTabData('map');
                document.querySelector('.tab-btn[data-tab="map"]').click();
            }
        });
    }

    function renderDistrictBreakdown(districts) {
        const sorted = [...districts].sort((a, b) => a.count - b.count);
        const trace = {
            y: sorted.map(d => 'D' + d.district + ': ' + d.name),
            x: sorted.map(d => d.count),
            type: 'bar',
            orientation: 'h',
            marker: { color: '#f0b429', opacity: 0.85 },
        };
        const layout = buildLayout({
            margin: { t: 10, r: 20, b: 40, l: 180 },
            yaxis: { automargin: true, gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)' },
            xaxis: { gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)', title: { text: 'Count', font: { size: 11, color: '#64748b' } } },
        });
        Plotly.newPlot('districtChart', [trace], layout, CHART_CONFIG);
        const districtMap = {};
        sorted.forEach(d => { districtMap['D' + d.district + ': ' + d.name] = d.district; });
        document.getElementById('districtChart').on('plotly_click', (data) => {
            if (data.points && data.points[0] && data.points[0].y) {
                const label = data.points[0].y;
                const dist = districtMap[label];
                if (dist != null) {
                    document.getElementById('globalDistrictFilter').value = String(dist);
                    updateClearFiltersVisibility();
                    tabDataLoaded.map = false;
                    loadTabData('map');
                    document.querySelector('.tab-btn[data-tab="map"]').click();
                }
            }
        });
    }

    function renderResolutionByCategory(resolution) {
        const cats = resolution.categories || [];
        if (cats.length === 0) return;
        const sorted = [...cats].sort((a, b) => b.avg_hours - a.avg_hours);
        const colors = sorted.map((c, i) => {
            const pct = i / Math.max(1, sorted.length - 1);
            return pct > 0.7 ? '#f87171' : pct > 0.3 ? '#fbbf24' : '#36d399';
        });
        const trace = {
            y: sorted.map(c => c.category),
            x: sorted.map(c => c.avg_hours),
            type: 'bar',
            orientation: 'h',
            marker: { color: colors },
            text: sorted.map(c => Math.round(c.avg_hours) + 'h'),
            textposition: 'outside',
            textfont: { size: 10, color: '#94a3b8' },
        };
        const layout = buildLayout({
            margin: { t: 10, r: 45, b: 40, l: 160 },
            yaxis: { automargin: true, gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)' },
            xaxis: { gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)', title: { text: 'Avg hours to close', font: { size: 11, color: '#64748b' } } },
        });
        Plotly.newPlot('resolutionByCategoryChart', [trace], layout, CHART_CONFIG);
        const slowest = sorted.slice(0, 3).map(c => c.category + ' (' + Math.round(c.avg_hours) + 'h)').join(', ');
        const fastest = sorted.slice(-3).reverse().map(c => c.category + ' (' + Math.round(c.avg_hours) + 'h)').join(', ');
        const el = document.getElementById('resolutionSlowestFastest');
        if (el) el.innerHTML = '<p><span class="font-medium" style="color:var(--text-primary)">Slowest to close:</span> ' + slowest + '</p><p><span class="font-medium" style="color:var(--text-primary)">Fastest to close:</span> ' + fastest + '</p>';
    }

    function renderResolutionByHour(byHour) {
        const sorted = byHour.sort((a, b) => a.hour - b.hour);
        const hours = sorted.map(r => r.hour + ':00');
        const avgH = sorted.map(r => r.avg_hours);
        const trace = {
            x: hours,
            y: avgH,
            type: 'bar',
            marker: { color: '#4c9aff', opacity: 0.7 },
            text: avgH.map(h => Math.round(h) + 'h'),
            textposition: 'outside',
            textfont: { size: 9, color: '#94a3b8' },
        };
        const layout = buildLayout({
            margin: { t: 10, r: 20, b: 50, l: 50 },
            xaxis: { gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)', tickangle: -45 },
            yaxis: { gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)', title: { text: 'Avg hours to close', font: { size: 11, color: '#64748b' } } },
        });
        Plotly.newPlot('resolutionByHourChart', [trace], layout, CHART_CONFIG);
    }

    function renderRecentTable(data) {
        const tbody = document.getElementById('recentTable');
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="py-10 text-center" style="color:var(--text-tertiary)">No recent data</td></tr>';
            return;
        }
        tbody.innerHTML = data.slice(0, 10).map(r => {
            const dNum = r.district != null ? Math.floor(r.district) : null;
            const dName = dNum !== null ? (DISTRICT_NAMES[dNum] ? 'D' + dNum + ': ' + DISTRICT_NAMES[dNum] : 'D' + dNum) : '--';
            const badgeClass = r.status === 'Closed' ? 'status-badge closed' : 'status-badge open';
            return '<tr>' +
                '<td>' + (r.opened ? new Date(r.opened).toLocaleDateString() : '--') + '</td>' +
                '<td class="font-medium" style="color:var(--text-primary)">' + (r.category || '--') + '</td>' +
                '<td class="max-w-xs truncate">' + (r.address || '--') + '</td>' +
                '<td>' + dName + '</td>' +
                '<td><span class="' + badgeClass + '">' + (r.status || '--') + '</span></td>' +
                '</tr>';
        }).join('');
    }

    // ---- Trends Tab ----

    async function loadTrends() {
        showSkeleton(['dowChart','hourlyChart','monthlyChart','growthChart','resolutionChart']);

        const params = getDateParams();
        const [dow, hourly, monthly, insights, resolution] = await Promise.all([
            apiFetch('/api/analytics/day-of-week' + params).catch(() => null),
            apiFetch('/api/analytics/hourly-pattern' + params).catch(() => null),
            apiFetch('/api/analytics/monthly-trends' + params).catch(() => null),
            apiFetch('/api/analytics/category-insights').catch(() => null),
            apiFetch('/api/analytics/resolution-time').catch(() => null),
        ]);

        // Day of week
        if (dow && dow.days) {
            const trace = {
                x: dow.days,
                y: dow.counts,
                type: 'bar',
                marker: { color: '#4c9aff', opacity: 0.85 },
            };
            const layout = buildLayout({
                margin: { t: 10, r: 20, b: 40, l: 50 },
                yaxis: { gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)', title: { text: 'Requests', font: { size: 11, color: '#64748b' } } },
            });
            Plotly.newPlot('dowChart', [trace], layout, CHART_CONFIG);

            const maxDay = dow.days[dow.counts.indexOf(Math.max(...dow.counts))];
            const minDay = dow.days[dow.counts.indexOf(Math.min(...dow.counts))];
            const diff = ((Math.max(...dow.counts) - Math.min(...dow.counts)) / Math.min(...dow.counts) * 100).toFixed(0);
            document.getElementById('dowInsight').textContent =
                maxDay + ' sees ' + diff + '% more requests than ' + minDay + '. Plan heavier staffing early in the week.';
        } else {
            showError('dowChart');
        }

        // Hourly
        if (hourly && hourly.hours) {
            const trace = {
                x: hourly.hours.map(h => h + ':00'),
                y: hourly.counts,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#f0b429', width: 2.5, shape: 'spline', smoothing: 1.3 },
                marker: { size: 5, color: '#f0b429' },
                fill: 'tozeroy',
                fillcolor: 'rgba(240,180,41,0.06)',
            };
            const layout = buildLayout({
                margin: { t: 10, r: 20, b: 40, l: 50 },
                yaxis: { gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)', title: { text: 'Requests', font: { size: 11, color: '#64748b' } } },
                annotations: [{
                    x: hourly.peak_hour + ':00',
                    y: hourly.peak_count,
                    text: 'Peak: ' + hourly.peak_hour + ':00',
                    showarrow: true, arrowhead: 2, ax: 0, ay: -30,
                    font: { size: 11, color: '#f0b429' },
                    arrowcolor: '#f0b429',
                }],
            });
            Plotly.newPlot('hourlyChart', [trace], layout, CHART_CONFIG);

            const total = hourly.counts.reduce((a, b) => a + b, 0);
            const morning = hourly.counts.slice(8, 12).reduce((a, b) => a + b, 0);
            const pct = (morning / total * 100).toFixed(0);
            document.getElementById('hourlyInsight').textContent =
                'Peak at ' + hourly.peak_hour + ':00. Morning rush (8-11 AM) accounts for ' + pct + '% of daily volume.';
        } else {
            showError('hourlyChart');
        }

        // Monthly
        if (monthly && monthly.months) {
            const trace = {
                x: monthly.months,
                y: monthly.counts,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#36d399', width: 2.5, shape: 'spline', smoothing: 1.3 },
                marker: { size: 5, color: '#36d399' },
                fill: 'tozeroy',
                fillcolor: 'rgba(54,211,153,0.06)',
            };
            const avgLine = {
                x: monthly.months,
                y: new Array(monthly.months.length).fill(monthly.average),
                type: 'scatter',
                mode: 'lines',
                line: { color: 'rgba(255,255,255,0.15)', width: 1, dash: 'dash' },
                name: 'Average',
                showlegend: false,
            };
            const layout = buildLayout({
                margin: { t: 10, r: 20, b: 40, l: 60 },
                yaxis: { gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)', title: { text: 'Requests', font: { size: 11, color: '#64748b' } } },
                showlegend: false,
            });
            Plotly.newPlot('monthlyChart', [trace, avgLine], layout, CHART_CONFIG);

            const maxIdx = monthly.counts.indexOf(Math.max(...monthly.counts));
            const spike = ((monthly.counts[maxIdx] - monthly.average) / monthly.average * 100).toFixed(0);
            document.getElementById('monthlyInsight').textContent =
                monthly.months[maxIdx] + ' peaked ' + spike + '% above average. Plan extra capacity during seasonal highs.';
        } else {
            showError('monthlyChart');
        }

        // Category growth
        if (insights && insights.category_growth_trends) {
            const trends = insights.category_growth_trends;
            const trace = {
                y: trends.map(t => t.category),
                x: trends.map(t => t.growth_pct),
                type: 'bar',
                orientation: 'h',
                marker: { color: trends.map(t => t.growth_pct < 0 ? '#36d399' : '#f87171') },
                text: trends.map(t => (t.growth_pct > 0 ? '+' : '') + t.growth_pct + '%'),
                textposition: 'outside',
                textfont: { size: 11, color: '#94a3b8' },
            };
            const layout = buildLayout({
                margin: { t: 10, r: 60, b: 40, l: 200 },
                yaxis: { automargin: true, gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)' },
                xaxis: { gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)', zeroline: true, zerolinecolor: 'rgba(255,255,255,0.1)', title: { text: 'Growth %', font: { size: 11, color: '#64748b' } } },
            });
            Plotly.newPlot('growthChart', [trace], layout, CHART_CONFIG);

            const declining = trends.filter(t => t.growth_pct < 0);
            document.getElementById('growthInsight').textContent =
                declining.length + ' categories declining. ' + (trends[0] ? trends[0].category + ' shows largest change at ' + trends[0].growth_pct + '%.' : '');
        } else {
            showError('growthChart');
        }

        // Resolution time
        if (resolution && resolution.categories && resolution.categories.length > 0) {
            const items = resolution.categories.slice(0, 10);
            const cats = items.map(c => c.category);
            const hours = items.map(c => c.avg_hours);
            const colors = hours.map(h => h > 72 ? '#f87171' : h > 24 ? '#fbbf24' : '#36d399');
            const trace = {
                y: cats,
                x: hours,
                type: 'bar',
                orientation: 'h',
                marker: { color: colors },
                text: hours.map(h => Math.round(h) + 'h'),
                textposition: 'outside',
                textfont: { size: 11, color: '#94a3b8' },
            };
            const layout = buildLayout({
                margin: { t: 10, r: 50, b: 40, l: 200 },
                yaxis: { automargin: true, gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)' },
                xaxis: { gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)', title: { text: 'Avg Hours to Resolution', font: { size: 11, color: '#64748b' } } },
            });
            Plotly.newPlot('resolutionChart', [trace], layout, CHART_CONFIG);
        } else {
            showError('resolutionChart');
        }
    }

    // ---- Map Tab (lazy-load Leaflet) ----

    function loadMapScripts() {
        if (mapScriptsLoaded) return Promise.resolve();
        if (mapScriptsPromise) return mapScriptsPromise;
        mapScriptsPromise = new Promise((resolve, reject) => {
            const base = 'https://unpkg.com';
            const links = [
                base + '/leaflet@1.9.4/dist/leaflet.css',
                base + '/leaflet.markercluster@1.4.1/dist/MarkerCluster.css',
                base + '/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css',
            ];
            const scripts = [
                base + '/leaflet@1.9.4/dist/leaflet.js',
                base + '/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js',
            ];
            let loaded = 0;
            const total = links.length + scripts.length;
            function checkDone() {
                if (++loaded === total) { mapScriptsLoaded = true; resolve(); }
            }
            links.forEach(href => {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = href;
                link.onload = checkDone;
                link.onerror = () => checkDone();
                document.head.appendChild(link);
            });
            scripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = checkDone;
                script.onerror = () => reject(new Error('Map scripts failed to load'));
                document.body.appendChild(script);
            });
        });
        return mapScriptsPromise;
    }

    function getMapApiParams() {
        const s = document.getElementById('startDate').value;
        const e = document.getElementById('endDate').value;
        const cat = document.getElementById('globalCategoryFilter').value;
        const dist = document.getElementById('globalDistrictFilter').value;
        let params = [];
        if (s) params.push('start_date=' + s);
        if (e) params.push('end_date=' + e);
        if (cat) params.push('category=' + encodeURIComponent(cat));
        if (dist) params.push('district=' + dist);
        return params.length ? '?' + params.join('&') : '';
    }

    async function loadMap() {
        await loadMapScripts();
        const loadingEl = document.getElementById('mapLoading');
        if (loadingEl) loadingEl.remove();
        if (!leafletMap) {
            leafletMap = L.map('mapContainer', { zoomControl: true }).setView([37.7749, -122.4194], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                maxZoom: 19,
            }).addTo(leafletMap);
        } else {
            Object.values(mapLayerGroups).forEach(lg => {
                if (leafletMap.hasLayer(lg)) leafletMap.removeLayer(lg);
            });
            mapLayerGroups = {};
            mapMarkerClusters = {};
        }

        try {
            const params = getMapApiParams();
            const data = await apiFetch('/api/analytics/map-data' + params);
            mapData = data;
            if (!data || !data.categories || data.categories.length === 0) {
                showMapEmpty(data && data.message ? data.message : null);
                return;
            }
            renderMapCategories(data.categories, data.format === 'heatmap');
        } catch (e) {
            showMapEmpty();
        }
    }

    function showMapEmpty(hint) {
        const container = document.getElementById('mapContainer');
        const overlay = document.createElement('div');
        overlay.className = 'absolute inset-0 flex items-center justify-center z-[1000] pointer-events-none';
        let msg = 'No geographic data available.';
        if (hint) msg += ' ' + hint;
        else msg += ' Run build_aggregates.py to generate grid_agg and recent_raw with coordinates, then redeploy.';
        overlay.innerHTML = '<div class="card-premium px-6 py-4 text-center max-w-md">' +
            '<p class="text-sm" style="color:var(--text-secondary)">' + msg + '</p></div>';
        container.style.position = 'relative';
        container.appendChild(overlay);
    }

    function renderMapCategories(categories, isHeatmap) {
        const colorMap = {};
        categories.forEach(c => { colorMap[c.category] = c.color; });

        const counts = categories.map(c => {
            const items = c.cells || c.points || [];
            return items.reduce((sum, p) => sum + (p.count || 1), 0);
        });
        const maxCount = Math.max(...counts, 1);

        categories.forEach(catObj => {
            if (isHeatmap && catObj.cells && catObj.cells.length > 0) {
                const lg = L.layerGroup();
                catObj.cells.forEach(cell => {
                    const count = cell.count || 1;
                    const radius = Math.max(4, Math.min(20, 4 + (count / maxCount) * 16));
                    L.circleMarker([cell.lat, cell.lon], {
                        radius,
                        fillColor: catObj.color,
                        color: catObj.color,
                        weight: 0.5,
                        fillOpacity: 0.5,
                    }).bindPopup('<strong>' + catObj.category + '</strong><br>' + count + ' requests')
                      .addTo(lg);
                });
                lg.addTo(leafletMap);
                mapLayerGroups[catObj.category] = lg;
            } else {
                const clusterGroup = L.markerClusterGroup({
                    chunkedLoading: true,
                    spiderfyOnMaxZoom: true,
                    showCoverageOnHover: false,
                });
                (catObj.points || []).forEach(p => {
                    if (p.lat != null && p.lon != null) {
                        const m = L.circleMarker([p.lat, p.lon], {
                            radius: 5,
                            fillColor: catObj.color,
                            color: catObj.color,
                            weight: 0.5,
                            fillOpacity: 0.6,
                        }).bindPopup('<strong>' + catObj.category + '</strong><br>' + p.lat.toFixed(4) + ', ' + p.lon.toFixed(4));
                        clusterGroup.addLayer(m);
                    }
                });
                clusterGroup.addTo(leafletMap);
                mapLayerGroups[catObj.category] = clusterGroup;
                mapMarkerClusters[catObj.category] = clusterGroup;
            }
        });

        // Render toggle chips
        const toggleContainer = document.getElementById('mapCategoryToggles');
        toggleContainer.innerHTML = '<div class="flex flex-wrap gap-2">' +
            categories.map(c =>
                '<label class="map-toggle-chip">' +
                '<input type="checkbox" checked class="sr-only" data-map-cat="' + c.category + '">' +
                '<span class="w-2.5 h-2.5 rounded-full inline-block" style="background:' + c.color + '"></span>' +
                '<span>' + c.category + ' (' + c.count + ')</span>' +
                '</label>'
            ).join('') + '</div>';

        toggleContainer.querySelectorAll('input[data-map-cat]').forEach(cb => {
            cb.addEventListener('change', () => {
                const cat = cb.getAttribute('data-map-cat');
                if (cb.checked) {
                    leafletMap.addLayer(mapLayerGroups[cat]);
                    cb.parentElement.classList.remove('disabled');
                } else {
                    leafletMap.removeLayer(mapLayerGroups[cat]);
                    cb.parentElement.classList.add('disabled');
                }
            });
            cb.parentElement.addEventListener('click', (e) => {
                if (e.target !== cb) {
                    cb.checked = !cb.checked;
                    cb.dispatchEvent(new Event('change'));
                }
            });
        });

        // Legend
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function () {
            const div = L.DomUtil.create('div', 'legend-panel');
            div.innerHTML = '<h4>Categories</h4>' +
                categories.map(c =>
                    '<div class="legend-item"><span class="legend-dot" style="background:' + c.color + '"></span>' + c.category + '</div>'
                ).join('');
            return div;
        };
        legend.addTo(leafletMap);

        setTimeout(() => leafletMap.invalidateSize(), 100);
    }

    // ---- Compare Tab ----

    async function loadCompare() {
        const params = getDateParams();
        const dataset = document.getElementById('compareDataset').value;
        const el = document.getElementById('compareResult');
        el.innerHTML = '<div class="skeleton" style="height:80px"></div>';
        try {
            const data = await apiFetch('/api/analytics/correlation?dataset=' + dataset + (params ? params.replace('?', '&') : ''));
            if (data.dataset === 'crime' && data.correlation != null) {
                el.innerHTML =
                    '<p><span class="font-medium" style="color:var(--text-primary)">Correlation (311 vs SFPD incidents):</span> ' + data.correlation.toFixed(3) + '</p>' +
                    '<p class="mt-2">Matched days: ' + (data.days_matched || 0) + '</p>' +
                    '<p>Avg 311 requests/day: ' + (data.avg_311 != null ? data.avg_311.toLocaleString() : '--') + '</p>' +
                    '<p>Avg incidents/day: ' + (data.avg_incidents != null ? data.avg_incidents.toLocaleString() : '--') + '</p>';
            } else if (data.event_days_avg_requests != null) {
                const lift = data.lift_percent != null ? data.lift_percent : 0;
                const liftColor = lift > 0 ? 'var(--red)' : lift < 0 ? 'var(--green)' : 'var(--text-secondary)';
                const topCats = (data.top_categories_on_event_days || []).slice(0, 5).map(c => c.category + ' (' + c.count + ')').join(', ') || '--';
                el.innerHTML =
                    '<p><span class="font-medium" style="color:var(--text-primary)">Avg requests on event days:</span> ' + data.event_days_avg_requests.toLocaleString() + ' (' + (data.event_days_count || 0) + ' days)</p>' +
                    '<p><span class="font-medium" style="color:var(--text-primary)">Avg requests on non-event days:</span> ' + data.non_event_days_avg_requests.toLocaleString() + ' (' + (data.non_event_days_count || 0) + ' days)</p>' +
                    '<p class="font-medium" style="color:' + liftColor + '">' + (lift > 0 ? '&#9650; ' : '') + (lift < 0 ? '&#9660; ' : '') + (lift !== 0 ? Math.abs(lift) + '%' : '0%') + ' on event days vs non-event days</p>' +
                    '<p class="text-xs mt-2" style="color:var(--text-tertiary)"><span class="font-medium">Top categories on event days:</span> ' + topCats + '</p>';
            } else {
                el.innerHTML = '<p style="color:var(--text-tertiary)">' + (data.message || 'No data for this dataset. Run the fetch scripts.') + '</p>';
            }
        } catch (e) {
            el.innerHTML = '<p style="color:var(--red)">Failed to load: ' + (e.message || 'Unknown error') + '</p>';
        }
    }

    // ---- Insights Tab ----

    async function loadInsights() {
        showSkeleton(['hotspotsChart']);

        const params = getDateParams();
        const [insights, monthly, eventCorr] = await Promise.all([
            apiFetch('/api/analytics/category-insights').catch(() => null),
            apiFetch('/api/analytics/monthly-trends' + params).catch(() => null),
            apiFetch('/api/analytics/event-correlation' + params).catch(() => null),
        ]);

        // Event correlation
        const ecEl = document.getElementById('eventCorrelation');
        if (eventCorr && eventCorr.event_days_avg_requests != null) {
            const lift = eventCorr.lift_percent != null ? eventCorr.lift_percent : 0;
            const liftColor = lift > 0 ? 'var(--red)' : lift < 0 ? 'var(--green)' : 'var(--text-secondary)';
            const topCats = (eventCorr.top_categories_on_event_days || []).slice(0, 5).map(c => c.category + ' (' + c.count + ')').join(', ') || '--';
            ecEl.innerHTML =
                '<div class="space-y-2">' +
                '<p><span class="font-medium" style="color:var(--text-primary)">Avg requests on event days:</span> ' + eventCorr.event_days_avg_requests.toLocaleString() + ' (' + (eventCorr.event_days_count || 0) + ' days)</p>' +
                '<p><span class="font-medium" style="color:var(--text-primary)">Avg requests on non-event days:</span> ' + eventCorr.non_event_days_avg_requests.toLocaleString() + ' (' + (eventCorr.non_event_days_count || 0) + ' days)</p>' +
                '<p class="font-medium" style="color:' + liftColor + '">' + (lift > 0 ? '&#9650; ' : '') + (lift < 0 ? '&#9660; ' : '') + (lift !== 0 ? Math.abs(lift) + '%' : '0%') + ' on event days vs non-event days</p>' +
                '<p class="text-xs mt-2" style="color:var(--text-tertiary)"><span class="font-medium">Top categories on event days:</span> ' + topCats + '</p>' +
                '</div>';
        } else {
            ecEl.innerHTML = '<p style="color:var(--text-tertiary)">' + (eventCorr && eventCorr.message ? eventCorr.message : 'Event data not available. Run: python scripts/fetch_events.py') + '</p>';
        }

        // District Hotspots
        if (insights && insights.district_hotspots && insights.district_hotspots.length > 0) {
            const hotspots = insights.district_hotspots;
            const traces = hotspots.map((h, i) => ({
                y: [h.category],
                x: [h.concentration],
                type: 'bar',
                orientation: 'h',
                name: 'D' + h.district + ' (' + (DISTRICT_NAMES[h.district] || '') + ')',
                marker: { color: PREMIUM_COLORS[i % PREMIUM_COLORS.length] },
                text: [h.concentration + '%'],
                textposition: 'outside',
                textfont: { size: 11, color: '#94a3b8' },
            }));
            const layout = buildLayout({
                margin: { t: 10, r: 60, b: 40, l: 180 },
                barmode: 'group',
                yaxis: { automargin: true, gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)' },
                xaxis: { gridcolor: 'rgba(255,255,255,0.04)', linecolor: 'rgba(255,255,255,0.06)', title: { text: '% Concentration', font: { size: 11, color: '#64748b' } } },
                showlegend: true,
                legend: { orientation: 'h', y: 1.12, x: 0.5, xanchor: 'center', font: { size: 11, color: '#94a3b8' } },
            });
            Plotly.newPlot('hotspotsChart', traces, layout, CHART_CONFIG);
        } else {
            showError('hotspotsChart');
        }

        // Recommendations
        const recs = [
            { title: 'Staff peak hours proactively', desc: 'Deploy 30% more field crews between 8-11 AM when request volume is highest.' },
            { title: 'Focus on D6 encampments', desc: '33% of encampment requests concentrate in SOMA/Tenderloin. Station dedicated teams there.' },
            { title: 'Reduce weekend crews', desc: 'Weekend volume drops significantly. Reallocate weekend staffing to weekday surge.' },
            { title: 'Pre-position for rain events', desc: 'Sewer and flooding requests spike on rainy days. Monitor weather forecasts to deploy crews early.' },
            { title: 'Graffiti team in D9', desc: '25% of graffiti reports come from Mission/Portola. Assign a dedicated crew to this district.' },
        ];
        document.getElementById('recommendations').innerHTML = recs.map((r, i) =>
            '<div class="card-premium p-4 flex items-start gap-3">' +
            '<div class="flex-shrink-0 w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold" style="background:var(--accent-muted);color:var(--accent)">' + (i + 1) + '</div>' +
            '<div>' +
            '<p class="text-[13px] font-semibold" style="color:var(--text-primary)">' + r.title + '</p>' +
            '<p class="text-xs mt-1" style="color:var(--text-tertiary)">' + r.desc + '</p>' +
            '</div></div>'
        ).join('');

        // Comparative summary
        if (monthly && monthly.months && monthly.counts && monthly.counts.length >= 2) {
            const len = monthly.counts.length;
            const thisMonth = monthly.counts[len - 1];
            const lastMonth = monthly.counts[len - 2];
            const change = ((thisMonth - lastMonth) / lastMonth * 100).toFixed(1);
            const color = change >= 0 ? 'var(--red)' : 'var(--green)';
            const arrow = change >= 0 ? '&#9650;' : '&#9660;';

            document.getElementById('comparativeSummary').innerHTML =
                '<div class="space-y-2">' +
                '<p><span class="font-medium" style="color:var(--text-primary)">This month (' + monthly.months[len - 1] + '):</span> ' + thisMonth.toLocaleString() + ' requests</p>' +
                '<p><span class="font-medium" style="color:var(--text-primary)">Last month (' + monthly.months[len - 2] + '):</span> ' + lastMonth.toLocaleString() + ' requests</p>' +
                '<p class="font-medium" style="color:' + color + '">' + arrow + ' ' + Math.abs(change) + '% ' + (change >= 0 ? 'up' : 'down') + ' month-over-month</p>' +
                '</div>';
        } else {
            document.getElementById('comparativeSummary').innerHTML =
                '<p class="text-center py-4" style="color:var(--text-tertiary)">Not enough data for comparison</p>';
        }

        // Compare periods
        (async () => {
            const now = new Date();
            const thisYear = now.getFullYear();
            const thisMonth = now.getMonth() + 1;
            const baseStart = thisYear + '-' + String(thisMonth).padStart(2, '0') + '-01';
            const lastDay = new Date(thisYear, thisMonth, 0).getDate();
            const baseEnd = thisYear + '-' + String(thisMonth).padStart(2, '0') + '-' + String(lastDay).padStart(2, '0');
            const compStart = (thisYear - 1) + '-' + String(thisMonth).padStart(2, '0') + '-01';
            const compLastDay = new Date(thisYear - 1, thisMonth, 0).getDate();
            const compEnd = (thisYear - 1) + '-' + String(thisMonth).padStart(2, '0') + '-' + String(compLastDay).padStart(2, '0');
            try {
                const cmp = await apiFetch('/api/analytics/compare-periods?base_start=' + baseStart + '&base_end=' + baseEnd + '&compare_start=' + compStart + '&compare_end=' + compEnd);
                if (cmp && cmp.base_period && cmp.compare_period) {
                    const baseTotal = cmp.base_period.total;
                    const compTotal = cmp.compare_period.total;
                    const pct = cmp.change_percent;
                    const color = pct == null ? '' : (pct >= 0 ? 'var(--red)' : 'var(--green)');
                    const arrow = pct == null ? '' : (pct >= 0 ? '&#9650;' : '&#9660;');
                    document.getElementById('comparePeriodsResult').innerHTML =
                        '<div class="space-y-2">' +
                        '<p><span class="font-medium" style="color:var(--text-primary)">This month (' + baseStart.slice(0, 7) + '):</span> ' + baseTotal.toLocaleString() + ' requests</p>' +
                        '<p><span class="font-medium" style="color:var(--text-primary)">Same month last year (' + compStart.slice(0, 7) + '):</span> ' + compTotal.toLocaleString() + ' requests</p>' +
                        (pct != null ? '<p class="font-medium" style="color:' + color + '">' + arrow + ' ' + Math.abs(pct) + '% vs last year</p>' : '<p style="color:var(--text-tertiary)">Insufficient historical data</p>') +
                        '</div>';
                } else {
                    document.getElementById('comparePeriodsResult').innerHTML = '<p style="color:var(--text-tertiary)">Unable to load comparison</p>';
                }
            } catch (e) {
                document.getElementById('comparePeriodsResult').innerHTML = '<p style="color:var(--text-tertiary)">Unable to load comparison</p>';
            }
        })();
    }

    function updateClearFiltersVisibility() {
        const cat = document.getElementById('globalCategoryFilter').value;
        const dist = document.getElementById('globalDistrictFilter').value;
        document.getElementById('clearDrillDown').classList.toggle('hidden', !cat && !dist);
    }

    // ---- Date Range + Category Filter ----

    function initFilters() {
        document.getElementById('applyDateRange').addEventListener('click', () => {
            tabDataLoaded.overview = false;
            tabDataLoaded.trends = false;
            tabDataLoaded.map = false;
            tabDataLoaded.insights = false;
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) loadTabData(activeTab.getAttribute('data-tab'));
        });

        document.getElementById('globalCategoryFilter').addEventListener('change', async (e) => {
            updateClearFiltersVisibility();
            const cat = e.target.value;
            tabDataLoaded.map = false;
            if (cat) {
                try {
                    const data = await apiFetch('/api/analytics/category-timeseries?category=' + encodeURIComponent(cat));
                    if (data && data.dates) {
                        renderVolumeChart(data);
                    }
                } catch (err) {
                    tabDataLoaded.overview = false;
                    loadTabData('overview');
                }
            } else {
                tabDataLoaded.overview = false;
                loadTabData('overview');
            }
        });

        document.getElementById('globalDistrictFilter').addEventListener('change', () => {
            updateClearFiltersVisibility();
            tabDataLoaded.overview = false;
            tabDataLoaded.trends = false;
            tabDataLoaded.map = false;
            tabDataLoaded.insights = false;
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) loadTabData(activeTab.getAttribute('data-tab'));
        });

        document.getElementById('clearDrillDown').addEventListener('click', () => {
            document.getElementById('globalCategoryFilter').value = '';
            document.getElementById('globalDistrictFilter').value = '';
            updateClearFiltersVisibility();
            tabDataLoaded.overview = false;
            tabDataLoaded.trends = false;
            tabDataLoaded.map = false;
            tabDataLoaded.insights = false;
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) loadTabData(activeTab.getAttribute('data-tab'));
        });

        document.getElementById('exportCsv').addEventListener('click', () => {
            const params = getDateParams();
            window.location.href = API_URL + '/api/data/export' + params;
        });

        document.getElementById('runCompare').addEventListener('click', () => loadCompare());

        // Data freshness
        apiFetch('/api/data/freshness').then(f => {
            if (f && (f['311'] || f.events || f.crime || f.weather)) {
                const parts = [];
                if (f['311']) parts.push('311 through ' + f['311']);
                if (f.events) parts.push('Events through ' + f.events);
                if (f.crime) parts.push('Crime through ' + f.crime);
                if (f.weather) parts.push('Weather through ' + f.weather);
                const el = document.getElementById('dataFreshness');
                if (el && parts.length) el.textContent = parts.join(' \u00b7 ') + ' \u00b7 data.sfgov.org';
            }
        }).catch(() => {});
    }

    // ---- Init ----

    document.addEventListener('DOMContentLoaded', () => {
        initTabs();
        initFilters();

        const hash = window.location.hash.replace('#', '');
        const activeTab = ['overview', 'trends', 'map', 'insights'].includes(hash) ? hash : 'overview';
        loadTabData(activeTab);
    });
    </script>
</body>
</html>
