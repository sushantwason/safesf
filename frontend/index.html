<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SF 311 Request Predictor</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-blue-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold flex items-center">
                            <i class="fas fa-chart-line mr-3"></i>
                            SF 311 Request Predictor
                        </h1>
                        <p class="text-blue-100 mt-1">Predictive analytics for San Francisco 311 service requests</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-blue-100">Powered by SF Open Data</div>
                        <div class="text-xs text-blue-200 mt-1">Updated daily at 6am PT</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Introduction Section -->
            <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg shadow p-6 mb-8">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-500 text-3xl"></i>
                    </div>
                    <div class="ml-4 flex-1">
                        <h2 class="text-2xl font-bold text-gray-800 mb-3">
                            <i class="fas fa-bullseye mr-2 text-blue-600"></i>
                            About This Tool
                        </h2>
                        <p class="text-gray-700 text-lg mb-4">
                            This dashboard helps you understand <strong>San Francisco's 311 service requests</strong> - the non-emergency issues residents report to the city like potholes, graffiti, street cleaning, illegal dumping, and more.
                        </p>

                        <div class="bg-white rounded-lg p-4 mb-4">
                            <h3 class="font-semibold text-gray-800 mb-2">✅ What You Can Do:</h3>
                            <ul class="space-y-2 text-gray-700">
                                <li><i class="fas fa-chart-line text-green-600 mr-2"></i>Explore <strong>50,000+ real 311 requests</strong> from the past 3 weeks</li>
                                <li><i class="fas fa-map-marked-alt text-green-600 mr-2"></i>See which neighborhoods need the most city services</li>
                                <li><i class="fas fa-search text-green-600 mr-2"></i>Identify trends and patterns in service requests</li>
                                <li><i class="fas fa-clock text-blue-600 mr-2"></i><em>[Future]</em> Predict future service demand to help the city plan resources</li>
                            </ul>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div class="bg-gradient-to-r from-blue-100 to-blue-50 p-3 rounded-lg">
                                <div class="font-semibold text-gray-700">Data Period</div>
                                <div class="text-gray-800">Jan 23 - Feb 13, 2026</div>
                            </div>
                            <div class="bg-gradient-to-r from-green-100 to-green-50 p-3 rounded-lg">
                                <div class="font-semibold text-gray-700">Total Requests</div>
                                <div class="text-gray-800" id="introTotalRequests">50,000</div>
                            </div>
                            <div class="bg-gradient-to-r from-purple-100 to-purple-50 p-3 rounded-lg">
                                <div class="font-semibold text-gray-700">Daily Average</div>
                                <div class="text-gray-800" id="introDailyAvg">2,273 requests/day</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500 text-sm">System Status</p>
                            <p class="text-2xl font-bold text-gray-800" id="systemStatus">Loading...</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i class="fas fa-layer-group text-blue-600 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500 text-sm">Request Types</p>
                            <p class="text-2xl font-bold text-gray-800" id="categoriesCount">-</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-purple-100 rounded-lg">
                            <i class="fas fa-database text-purple-600 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500 text-sm">Total Requests</p>
                            <p class="text-2xl font-bold text-gray-800" id="totalRequestsCount">50,000</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-orange-100 rounded-lg">
                            <i class="fas fa-chart-bar text-orange-600 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500 text-sm">Daily Average</p>
                            <p class="text-2xl font-bold text-gray-800" id="dailyAvgCount">2,273</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historical Data Dashboard -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-history mr-2 text-blue-600"></i>
                    Historical Data (Real 311 Requests)
                </h2>

                <!-- Volume Over Time -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">
                                <i class="fas fa-chart-line mr-2 text-blue-600"></i>
                                Request Volume Over Time
                            </h3>
                            <p class="text-gray-600 text-sm mt-1">
                                <i class="fas fa-info-circle mr-1"></i>
                                Daily count of 311 requests. Spikes may indicate city events, weather issues, or service problems.
                            </p>
                        </div>
                    </div>
                    <div id="historicalVolumeChart" class="h-96"></div>
                </div>

                <!-- Two column layout for Category and Recent -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Top Categories -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">
                            <i class="fas fa-list-ol mr-2 text-green-600"></i>
                            Top Request Categories
                        </h3>
                        <p class="text-gray-600 text-sm mb-4">
                            <i class="fas fa-info-circle mr-1"></i>
                            Most common types of 311 requests submitted by SF residents.
                        </p>
                        <div id="categoriesChart" class="h-96"></div>
                    </div>

                    <!-- Geographic Distribution -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">
                            <i class="fas fa-map-marked-alt mr-2 text-purple-600"></i>
                            Requests by District
                        </h3>
                        <p class="text-gray-600 text-sm mb-4">
                            <i class="fas fa-info-circle mr-1"></i>
                            Service request distribution across SF's 11 supervisor districts.
                        </p>
                        <div id="geographicChart" class="h-96"></div>
                    </div>
                </div>

                <!-- Recent Requests Table -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-stream mr-2 text-orange-600"></i>
                        Recent Service Requests
                    </h3>
                    <p class="text-gray-600 text-sm mb-4">
                        <i class="fas fa-info-circle mr-1"></i>
                        Latest 20 requests submitted to SF's 311 system. Refreshed from live data.
                    </p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">District</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentRequestsTable" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="5" class="px-4 py-3 text-center text-gray-500">Loading recent requests...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Prediction Controls (Coming Soon) -->
            <div class="bg-yellow-50 border-l-4 border-yellow-500 rounded-lg shadow p-6 mb-6">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">
                            ⚠️ Predictions Coming Soon
                        </h3>
                        <p class="text-gray-700 mb-3">
                            Machine learning models are not yet trained. To enable predictions, we need:
                        </p>
                        <ol class="list-decimal list-inside space-y-1 text-gray-700 mb-3">
                            <li>Collect more historical data (need 6+ months)</li>
                            <li>Train Prophet and XGBoost forecasting models</li>
                            <li>Deploy updated models to production</li>
                        </ol>
                        <p class="text-gray-600 text-sm">
                            <strong>For now:</strong> Explore the historical data above to understand request patterns and trends.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Prediction Controls -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-sliders-h mr-2"></i>
                    Prediction Controls
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <select id="categorySelect" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="">Loading categories...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Forecast Days</label>
                        <input type="number" id="forecastDays" value="7" min="1" max="30"
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                        <select id="modelSelect" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="prophet">Prophet (Time Series)</option>
                            <option value="xgboost">XGBoost (ML)</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="getPrediction()"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">
                            <i class="fas fa-magic mr-2"></i>
                            Generate Prediction
                        </button>
                    </div>
                </div>
            </div>

            <!-- Prediction Chart -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-chart-area mr-2"></i>
                    Volume Prediction
                </h2>
                <div id="predictionChart" class="h-96"></div>
            </div>

            <!-- Trends Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-trending-up mr-2"></i>
                        30-Day Trends
                    </h2>
                    <div id="trendsContainer" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">Select a category to view trends</p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-map-marked-alt mr-2"></i>
                        Predicted Hotspots
                    </h2>
                    <div id="hotspotsContainer" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">Loading hotspot predictions...</p>
                    </div>
                </div>
            </div>

            <!-- Model Performance -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-chart-bar mr-2"></i>
                    Model Performance Metrics
                </h2>
                <div id="metricsTable" class="overflow-x-auto">
                    <p class="text-gray-500 text-center py-8">Loading metrics...</p>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white mt-12">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm">Built with SF Open Data for the public good</p>
                        <p class="text-xs text-gray-400 mt-1">Data updated nightly from data.sfgov.org</p>
                    </div>
                    <div class="flex space-x-4">
                        <a href="https://data.sfgov.org/" target="_blank" class="text-gray-400 hover:text-white transition">
                            <i class="fas fa-database"></i> Data Source
                        </a>
                        <a href="/docs" class="text-gray-400 hover:text-white transition">
                            <i class="fas fa-book"></i> API Docs
                        </a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        const API_URL = window.location.origin;  // Adjust for your deployment

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await checkHealth();
            await loadCategories();
            await loadMetrics();

            // Load historical data visualizations
            await loadHistoricalTrends();
            await loadCategoryBreakdown();
            await loadRecentRequests();
            await loadGeographicData();

            // Load prediction features (will show as unavailable if models not loaded)
            await loadHotspots();
        });

        async function checkHealth() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();

                document.getElementById('systemStatus').textContent = data.status === 'healthy' ? 'Healthy' : 'Warning';
                document.getElementById('categoriesCount').textContent = data.categories_available.length;
                document.getElementById('modelsCount').textContent = data.models_loaded;
            } catch (error) {
                console.error('Health check failed:', error);
                document.getElementById('systemStatus').textContent = 'Error';
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/api/categories`);
                const data = await response.json();

                const select = document.getElementById('categorySelect');
                select.innerHTML = data.categories.map(cat =>
                    `<option value="${cat}">${cat}</option>`
                ).join('');
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }

        async function getPrediction() {
            const category = document.getElementById('categorySelect').value;
            const days = document.getElementById('forecastDays').value;
            const model = document.getElementById('modelSelect').value;

            if (!category) {
                alert('Please select a category');
                return;
            }

            try {
                const response = await fetch(
                    `${API_URL}/api/predict/volume?category=${encodeURIComponent(category)}&days=${days}&model=${model}`
                );
                const data = await response.json();

                // Plot predictions
                plotPrediction(data);

                // Load trends for this category
                loadTrends(category);

            } catch (error) {
                console.error('Prediction failed:', error);
                alert('Prediction failed: ' + error.message);
            }
        }

        function plotPrediction(data) {
            const dates = data.predictions.map(p => p.date);
            const volumes = data.predictions.map(p => p.predicted_volume);
            const lowerBounds = data.predictions.map(p => p.lower_bound || p.predicted_volume * 0.8);
            const upperBounds = data.predictions.map(p => p.upper_bound || p.predicted_volume * 1.2);

            const traces = [
                {
                    x: dates,
                    y: volumes,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Predicted Volume',
                    line: { color: '#2563eb', width: 3 },
                    marker: { size: 8 }
                },
                {
                    x: dates,
                    y: upperBounds,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Upper Bound',
                    line: { color: '#93c5fd', width: 1, dash: 'dash' },
                    fill: 'tonexty',
                    fillcolor: 'rgba(37, 99, 235, 0.1)'
                },
                {
                    x: dates,
                    y: lowerBounds,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Lower Bound',
                    line: { color: '#93c5fd', width: 1, dash: 'dash' }
                }
            ];

            const layout = {
                title: `Predicted 311 Requests: ${data.category}`,
                xaxis: { title: 'Date' },
                yaxis: { title: 'Number of Requests' },
                hovermode: 'x unified',
                showlegend: true
            };

            Plotly.newPlot('predictionChart', traces, layout, { responsive: true });
        }

        async function loadTrends(category = 'all') {
            try {
                const response = await fetch(`${API_URL}/api/predict/trends?category=${category}&timeframe=30d`);
                const data = await response.json();

                const container = document.getElementById('trendsContainer');
                container.innerHTML = Object.entries(data.trends).map(([cat, trend]) => `
                    <div class="border-l-4 ${trend.direction === 'increasing' ? 'border-red-500' : 'border-green-500'} pl-4 py-2">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-800">${cat}</span>
                            <span class="text-sm ${trend.direction === 'increasing' ? 'text-red-600' : 'text-green-600'}">
                                <i class="fas fa-arrow-${trend.direction === 'increasing' ? 'up' : 'down'}"></i>
                                ${trend.magnitude_percent}%
                            </span>
                        </div>
                        <div class="text-sm text-gray-600 mt-1">
                            Predicted total: ${trend.predicted_total} | Daily avg: ${trend.daily_average}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load trends:', error);
            }
        }

        async function loadHotspots() {
            try {
                const response = await fetch(`${API_URL}/api/predict/hotspots?top_n=5`);
                const data = await response.json();

                const container = document.getElementById('hotspotsContainer');
                container.innerHTML = data.hotspots.map((spot, idx) => `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-semibold">
                                    #${idx + 1}
                                </span>
                                <h3 class="font-semibold text-gray-800 mt-2">${spot.neighborhood}</h3>
                                <p class="text-sm text-gray-600">Predicted volume: ${spot.predicted_volume}</p>
                            </div>
                        </div>
                        <div class="mt-2 flex flex-wrap gap-1">
                            ${spot.top_categories.map(cat =>
                                `<span class="text-xs bg-gray-200 px-2 py-1 rounded">${cat}</span>`
                            ).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load hotspots:', error);
            }
        }

        // NEW: Historical Data Functions
        async function loadHistoricalTrends() {
            try {
                const response = await fetch(`${API_URL}/api/data/stats`);
                const data = await response.json();

                // Get recent data to build time series
                const recentResponse = await fetch(`${API_URL}/api/data/recent?limit=1000`);
                const recentData = await recentResponse.json();

                // Group by date
                const dateGroups = {};
                recentData.data.forEach(req => {
                    if (req.opened) {
                        const date = req.opened.split('T')[0];
                        dateGroups[date] = (dateGroups[date] || 0) + 1;
                    }
                });

                const dates = Object.keys(dateGroups).sort();
                const volumes = dates.map(d => dateGroups[d]);

                const trace = {
                    x: dates,
                    y: volumes,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Daily Requests',
                    line: { color: '#3b82f6', width: 2 },
                    marker: { size: 6 }
                };

                const layout = {
                    title: 'Request Volume Over Time',
                    xaxis: { title: 'Date' },
                    yaxis: { title: 'Number of Requests' },
                    hovermode: 'x unified',
                    showlegend: false,
                    margin: { t: 40, r: 20, b: 40, l: 60 }
                };

                Plotly.newPlot('historicalVolumeChart', [trace], layout, { responsive: true });
            } catch (error) {
                console.error('Failed to load historical trends:', error);
                document.getElementById('historicalVolumeChart').innerHTML =
                    '<p class="text-red-600 p-4">Error loading trend data</p>';
            }
        }

        async function loadCategoryBreakdown() {
            try {
                const response = await fetch(`${API_URL}/api/data/stats`);
                const data = await response.json();

                // Get top 10 categories
                const categories = Object.entries(data.top_categories || data.categories || {})
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

                const trace = {
                    x: categories.map(c => c[1]),
                    y: categories.map(c => c[0]),
                    type: 'bar',
                    orientation: 'h',
                    marker: { color: '#3b82f6' }
                };

                const layout = {
                    title: 'Top 10 Request Categories',
                    xaxis: { title: 'Number of Requests' },
                    yaxis: { title: '' },
                    margin: { t: 40, r: 20, b: 40, l: 150 },
                    height: 400
                };

                Plotly.newPlot('categoriesChart', [trace], layout, { responsive: true });
            } catch (error) {
                console.error('Failed to load category breakdown:', error);
                document.getElementById('categoriesChart').innerHTML =
                    '<p class="text-red-600 p-4">Error loading category data</p>';
            }
        }

        async function loadRecentRequests() {
            try {
                const response = await fetch(`${API_URL}/api/data/recent?limit=20`);
                const data = await response.json();

                const tbody = document.getElementById('recentRequestsTable');
                tbody.innerHTML = data.data.map(req => {
                    const districtDisplay = req.district !== null && req.district !== undefined ?
                        Math.floor(req.district) : 'N/A';
                    return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-2 text-sm">${req.opened ? new Date(req.opened).toLocaleDateString() : 'N/A'}</td>
                        <td class="px-4 py-2 text-sm">${req.category}</td>
                        <td class="px-4 py-2 text-sm">${req.address || 'N/A'}</td>
                        <td class="px-4 py-2 text-sm text-center">${districtDisplay}</td>
                        <td class="px-4 py-2 text-sm">
                            <span class="inline-block px-2 py-1 rounded text-xs ${
                                req.status === 'Closed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                            }">
                                ${req.status}
                            </span>
                        </td>
                    </tr>
                `}).join('');
            } catch (error) {
                console.error('Failed to load recent requests:', error);
                document.getElementById('recentRequestsTable').innerHTML =
                    '<tr><td colspan="5" class="text-center text-red-600 p-4">Error loading recent requests</td></tr>';
            }
        }

        async function loadGeographicData() {
            try {
                const response = await fetch(`${API_URL}/api/data/recent?limit=1000`);
                const data = await response.json();

                // Group by district
                const districtGroups = {};
                data.data.forEach(req => {
                    if (req.district !== null && req.district !== 'N/A' && req.district !== undefined) {
                        const district = Math.floor(req.district).toString();
                        districtGroups[district] = (districtGroups[district] || 0) + 1;
                    }
                });

                const districts = Object.entries(districtGroups)
                    .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));

                const trace = {
                    x: districts.map(d => `District ${d[0]}`),
                    y: districts.map(d => d[1]),
                    type: 'bar',
                    marker: { color: '#10b981' }
                };

                const layout = {
                    title: 'Requests by Supervisor District',
                    xaxis: { title: 'District' },
                    yaxis: { title: 'Number of Requests' },
                    margin: { t: 40, r: 20, b: 60, l: 60 }
                };

                Plotly.newPlot('geographicChart', [trace], layout, { responsive: true });
            } catch (error) {
                console.error('Failed to load geographic data:', error);
                document.getElementById('geographicChart').innerHTML =
                    '<p class="text-red-600 p-4">Error loading geographic data</p>';
            }
        }

        async function loadMetrics() {
            try {
                const response = await fetch(`${API_URL}/api/data/stats`);
                const data = await response.json();

                // Update status cards with real data
                const numCategories = Object.keys(data.categories || {}).length;
                document.getElementById('categoriesCount').textContent = numCategories.toLocaleString();
                document.getElementById('totalRequestsCount').textContent = (data.total_requests || 0).toLocaleString();
                document.getElementById('dailyAvgCount').textContent = Math.round(data.daily_average || 0).toLocaleString();
            } catch (error) {
                console.error('Failed to load metrics:', error);
            }
        }
    </script>
</body>
</html>
